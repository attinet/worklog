@* 月份標題與切換按鈕 *@
<div class="d-flex justify-space-between align-center mb-4">
    <MudIconButton Icon="@Icons.Material.Filled.ChevronLeft" 
                   OnClick="PreviousMonth" 
                   Color="Color.Primary" 
                   Size="Size.Small" />
    <MudText Typo="Typo.h6">@currentMonth.ToString("yyyy年 M月")</MudText>
    <MudIconButton Icon="@Icons.Material.Filled.ChevronRight" 
                   OnClick="NextMonth" 
                   Color="Color.Primary" 
                   Size="Size.Small" />
</div>

@* 星期標題 *@
<div class="calendar-week-header">
    @foreach (var day in new[] { "日", "一", "二", "三", "四", "五", "六" })
    {
        <div class="calendar-day-header">
            <MudText Typo="Typo.subtitle2" Color="Color.Secondary">@day</MudText>
        </div>
    }
</div>

@* 日期網格 *@
<div class="calendar-grid">
    @foreach (var date in GetCalendarDates())
    {
        <div class="calendar-cell">
            <MudPaper Class="@GetDateClass(date)" 
                     @onclick="() => SelectDate(date)" 
                     Style="@($"width: 100%; min-height: 80px; cursor: pointer; {GetDateStyle(date)}")">
                <div class="d-flex flex-column align-center pa-2">
                    <MudText Typo="Typo.body2">@date.Day</MudText>
                    
                    @* 顯示工作紀錄數量和工時 *@
                    @if (WorkLogsByDate.ContainsKey(date))
                    {
                        var logs = WorkLogsByDate[date];
                        var totalHours = logs.Sum(l => l.WorkHours);
                        
                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Class="mt-1" Style="height: 20px; font-size: 0.7rem;">
                            @logs.Count
                        </MudChip>
                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Style="height: 18px; font-size: 0.65rem;">
                            @totalHours.ToString("0.#")h
                        </MudChip>
                    }
                </div>
            </MudPaper>
        </div>
    }
</div>

<style>
    .calendar-week-header {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
        margin-bottom: 8px;
    }

    .calendar-day-header {
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 8px;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px;
    }

    .calendar-cell {
        display: flex;
        justify-content: center;
    }
</style>

@code {
    [Parameter]
    public DateTime CurrentMonth { get; set; } = DateTime.Today;

    [Parameter]
    public Dictionary<DateOnly, List<WorkLogResponse>> WorkLogsByDate { get; set; } = new();

    [Parameter]
    public DateOnly? SelectedDate { get; set; }

    [Parameter]
    public EventCallback<DateOnly> OnDateSelected { get; set; }

    [Parameter]
    public EventCallback<DateTime> OnMonthChanged { get; set; }

    private DateTime currentMonth;
    private DateOnly today = DateOnly.FromDateTime(DateTime.Today);

    protected override void OnParametersSet()
    {
        currentMonth = CurrentMonth;
    }

    private List<DateOnly> GetCalendarDates()
    {
        var dates = new List<DateOnly>();
        var firstDayOfMonth = new DateOnly(currentMonth.Year, currentMonth.Month, 1);
        var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);

        // 取得本月第一天是星期幾 (0=日, 1=一, ..., 6=六)
        int startDayOfWeek = (int)firstDayOfMonth.DayOfWeek;

        // 填充上個月的日期
        var previousMonthStart = firstDayOfMonth.AddDays(-startDayOfWeek);
        for (int i = 0; i < startDayOfWeek; i++)
        {
            dates.Add(previousMonthStart.AddDays(i));
        }

        // 填充本月的日期
        for (int day = 1; day <= lastDayOfMonth.Day; day++)
        {
            dates.Add(new DateOnly(currentMonth.Year, currentMonth.Month, day));
        }

        // 填充下個月的日期以完成6週
        int remainingDays = 42 - dates.Count; // 6週 = 42天
        var nextMonthStart = lastDayOfMonth.AddDays(1);
        for (int i = 0; i < remainingDays; i++)
        {
            dates.Add(nextMonthStart.AddDays(i));
        }

        return dates;
    }

    private string GetDateClass(DateOnly date)
    {
        var classes = new List<string>();
        
        var isCurrentMonth = date.Month == currentMonth.Month;
        var isToday = date == today;
        var isSelected = date == SelectedDate;
        var hasLogs = WorkLogsByDate.ContainsKey(date);

        // 不是當月的日期變淡
        if (!isCurrentMonth)
        {
            classes.Add("mud-text-disabled");
        }

        return string.Join(" ", classes);
    }

    private string GetDateStyle(DateOnly date)
    {
        var styles = new List<string>();
        
        var isCurrentMonth = date.Month == currentMonth.Month;
        var isToday = date == today;
        var isSelected = date == SelectedDate;
        var hasLogs = WorkLogsByDate.ContainsKey(date);

        // 背景顏色
        if (isSelected)
        {
            styles.Add("background-color: var(--mud-palette-primary-lighten)");
            styles.Add("border: 2px solid var(--mud-palette-primary)");
        }
        else if (isToday)
        {
            styles.Add("background-color: var(--mud-palette-warning-lighten)");
            styles.Add("border: 1px solid var(--mud-palette-warning)");
        }
        else if (hasLogs)
        {
            styles.Add("border-left: 3px solid var(--mud-palette-info)");
        }
        
        if (!isCurrentMonth)
        {
            styles.Add("opacity: 0.5");
            styles.Add("cursor: default");
        }

        return string.Join("; ", styles);
    }

    private async Task SelectDate(DateOnly date)
    {
        // 只允許選擇當前月份的日期
        if (date.Month != currentMonth.Month)
            return;

        await OnDateSelected.InvokeAsync(date);
    }

    private async Task PreviousMonth()
    {
        currentMonth = currentMonth.AddMonths(-1);
        await OnMonthChanged.InvokeAsync(currentMonth);
    }

    private async Task NextMonth()
    {
        currentMonth = currentMonth.AddMonths(1);
        await OnMonthChanged.InvokeAsync(currentMonth);
    }
}
