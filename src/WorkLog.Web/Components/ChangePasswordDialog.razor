@using WorkLog.Shared.DTOs
@using WorkLog.Shared.DTOs.Admin
@inject HttpClient Http
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudText Typo="Typo.body2" Class="mb-4">
            為使用者 <strong>@Username</strong> 設定新密碼
        </MudText>

        <EditForm Model="@request" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />
            
            <MudTextField @bind-Value="request.NewPassword" 
                         Label="新密碼" 
                         Variant="Variant.Outlined"
                         For="@(() => request.NewPassword)"
                         InputType="InputType.Password"
                         Required="true"
                         Immediate="true"
                         HelperText="至少 6 個字元" />
        </EditForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">取消</MudButton>
        <MudButton OnClick="HandleSubmit" 
                  Variant="Variant.Filled" 
                  Color="Color.Primary"
                  Disabled="@isSubmitting">
            @(isSubmitting ? "處理中..." : "確定修改")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] MudDialogInstance MudDialog { get; set; } = null!;
    [Parameter] public int UserId { get; set; }
    [Parameter] public string Username { get; set; } = string.Empty;
    [Parameter] public EventCallback OnPasswordChanged { get; set; }

    private ChangePasswordRequest request = new();
    private bool isSubmitting = false;

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        try
        {
            var response = await Http.PutAsJsonAsync($"api/admin/users/{UserId}/password", request);
            
            if (response.IsSuccessStatusCode)
            {
                await OnPasswordChanged.InvokeAsync();
                MudDialog.Close();
            }
            else
            {
                var error = await response.Content.ReadFromJsonAsync<ApiErrorResponse>();
                Snackbar.Add(error?.Message ?? "修改密碼失敗", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"修改密碼失敗: {ex.Message}", Severity.Error);
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
