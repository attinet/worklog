@using WorkLog.Shared.DTOs.Todos
@using WorkLog.Web.Services
@inject TodoService TodoService
@inject NavigationManager Navigation

<div class="bg-white rounded-lg shadow-sm p-6">
    <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-gray-800">æˆ‘çš„å¾…è¾¦äº‹é …</h2>
        <a href="/todos" class="text-blue-600 hover:text-blue-800 text-sm">æŸ¥çœ‹å…¨éƒ¨ â†’</a>
    </div>

    @if (loading)
    {
        <div class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
        </div>
    }
    else if (dashboard == null)
    {
        <div class="text-center py-8 text-gray-500">
            ç„¡æ³•è¼‰å…¥å¾…è¾¦äº‹é …
        </div>
    }
    else
    {
        <!-- çµ±è¨ˆæ‘˜è¦ -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="text-center p-3 bg-gray-50 rounded">
                <div class="text-2xl font-bold text-gray-800">@dashboard.PendingCount</div>
                <div class="text-xs text-gray-600">å¾…è™•ç†</div>
            </div>
            <div class="text-center p-3 bg-blue-50 rounded">
                <div class="text-2xl font-bold text-blue-600">@dashboard.InProgressCount</div>
                <div class="text-xs text-gray-600">é€²è¡Œä¸­</div>
            </div>
            <div class="text-center p-3 bg-yellow-50 rounded">
                <div class="text-2xl font-bold text-yellow-600">@dashboard.DueTodayCount</div>
                <div class="text-xs text-gray-600">ä»Šæ—¥åˆ°æœŸ</div>
            </div>
            <div class="text-center p-3 bg-red-50 rounded">
                <div class="text-2xl font-bold text-red-600">@dashboard.OverdueCount</div>
                <div class="text-xs text-gray-600">é€¾æœŸ</div>
            </div>
        </div>

        <!-- ä»Šæ—¥åˆ°æœŸ -->
        @if (dashboard.DueTodayItems.Count > 0)
        {
            <div class="mb-4">
                <h3 class="text-sm font-semibold text-gray-700 mb-2">ğŸ“… ä»Šæ—¥åˆ°æœŸ</h3>
                @foreach (var todo in dashboard.DueTodayItems)
                {
                    <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded cursor-pointer" @onclick="() => NavigateToTodo(todo.Id)">
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">@todo.Title</div>
                            <div class="text-xs text-gray-600">
                                <span class="@GetPriorityClass(todo.Priority)">@GetPriorityText(todo.Priority)</span>
                            </div>
                        </div>
                        <span class="@GetStatusClass(todo.Status)">@GetStatusText(todo.Status)</span>
                    </div>
                }
            </div>
        }

        <!-- é€¾æœŸå¾…è¾¦ -->
        @if (dashboard.OverdueItems.Count > 0)
        {
            <div>
                <h3 class="text-sm font-semibold text-red-700 mb-2">âš ï¸ é€¾æœŸå¾…è¾¦</h3>
                @foreach (var todo in dashboard.OverdueItems)
                {
                    <div class="flex items-center justify-between p-2 hover:bg-gray-50 rounded border-l-2 border-red-500 cursor-pointer" @onclick="() => NavigateToTodo(todo.Id)">
                        <div class="flex-1">
                            <div class="font-medium text-gray-800">@todo.Title</div>
                            <div class="text-xs text-red-600">
                                é€¾æœŸ @(DateTime.Now - todo.DueDate!.Value).Days å¤©
                            </div>
                        </div>
                        <span class="@GetStatusClass(todo.Status)">@GetStatusText(todo.Status)</span>
                    </div>
                }
            </div>
        }

        @if (dashboard.DueTodayItems.Count == 0 && dashboard.OverdueItems.Count == 0)
        {
            <div class="text-center py-8 text-gray-500">
                <p>âœ… ç›®å‰æ²’æœ‰ç·Šæ€¥å¾…è¾¦äº‹é …</p>
            </div>
        }
    }
</div>

@code {
    private TodoDashboardResponse? dashboard;
    private bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboard();
    }

    private async Task LoadDashboard()
    {
        loading = true;
        dashboard = await TodoService.GetDashboardAsync();
        loading = false;
    }

    private void NavigateToTodo(int id) => Navigation.NavigateTo($"/todos/edit/{id}");

    private string GetPriorityClass(string priority) => priority switch
    {
        "High" => "px-2 py-0.5 rounded bg-red-100 text-red-800",
        "Medium" => "px-2 py-0.5 rounded bg-yellow-100 text-yellow-800",
        "Low" => "px-2 py-0.5 rounded bg-green-100 text-green-800",
        _ => "px-2 py-0.5 rounded bg-gray-100 text-gray-800"
    };

    private string GetPriorityText(string priority) => priority switch
    {
        "High" => "é«˜",
        "Medium" => "ä¸­",
        "Low" => "ä½",
        _ => priority
    };

    private string GetStatusClass(string status) => status switch
    {
        "Pending" => "text-xs px-2 py-1 rounded bg-gray-100 text-gray-800",
        "InProgress" => "text-xs px-2 py-1 rounded bg-blue-100 text-blue-800",
        "Completed" => "text-xs px-2 py-1 rounded bg-green-100 text-green-800",
        _ => "text-xs px-2 py-1 rounded bg-gray-100 text-gray-800"
    };

    private string GetStatusText(string status) => status switch
    {
        "Pending" => "å¾…è™•ç†",
        "InProgress" => "é€²è¡Œä¸­",
        "Completed" => "å·²å®Œæˆ",
        _ => status
    };
}
