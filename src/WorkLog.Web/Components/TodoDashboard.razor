@using WorkLog.Shared.DTOs.Todos
@using WorkLog.Web.Services
@inject TodoService TodoService
@inject NavigationManager Navigation
@inject IDialogService DialogService

<MudPaper Elevation="2" Class="pa-4">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h5">æˆ‘çš„å¾…è¾¦äº‹é …</MudText>
        <MudButton Variant="Variant.Text" 
                  Color="Color.Primary" 
                  EndIcon="@Icons.Material.Filled.ArrowForward"
                  Href="/todos">
            æŸ¥çœ‹å…¨éƒ¨
        </MudButton>
    </div>

    @if (loading)
    {
        <div class="text-center py-8">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
        </div>
    }
    else if (dashboard == null)
    {
        <MudAlert Severity="Severity.Warning">ç„¡æ³•è¼‰å…¥å¾…è¾¦äº‹é …</MudAlert>
    }
    else
    {
        <!-- çµ±è¨ˆæ‘˜è¦ -->
        <MudGrid Class="mb-4">
            <MudItem xs="6" md="3">
                <MudPaper Elevation="0" Class="pa-3 text-center" Style="background: rgba(0,0,0,0.03)">
                    <MudText Typo="Typo.h4">@dashboard.PendingCount</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">å¾…è™•ç†</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="6" md="3">
                <MudPaper Elevation="0" Class="pa-3 text-center" Style="background: rgba(33, 150, 243, 0.1)">
                    <MudText Typo="Typo.h4" Color="Color.Info">@dashboard.InProgressCount</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">é€²è¡Œä¸­</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="6" md="3">
                <MudPaper Elevation="0" Class="pa-3 text-center" Style="background: rgba(255, 152, 0, 0.1)">
                    <MudText Typo="Typo.h4" Color="Color.Warning">@dashboard.DueTodayCount</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">ä»Šæ—¥åˆ°æœŸ</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="6" md="3">
                <MudPaper Elevation="0" Class="pa-3 text-center" Style="background: rgba(244, 67, 54, 0.1)">
                    <MudText Typo="Typo.h4" Color="Color.Error">@dashboard.OverdueCount</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">é€¾æœŸ</MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <!-- ä»Šæ—¥åˆ°æœŸ -->
        @if (dashboard.DueTodayItems.Count > 0)
        {
            <div class="mb-4">
                <MudText Typo="Typo.subtitle2" Class="mb-2">ğŸ“… ä»Šæ—¥åˆ°æœŸ</MudText>
                <MudPaper Elevation="0" Class="mud-list">
                    @foreach (var todo in dashboard.DueTodayItems)
                    {
                        <MudListItem T="string" OnClick="@(() => NavigateToTodo(todo.Id))" Class="mud-list-item-clickable">
                            <div class="d-flex justify-space-between align-center">
                                <div style="flex: 1">
                                    <MudText Typo="Typo.body2">@todo.Title</MudText>
                                    <MudChip T="string" Size="Size.Small" Color="@GetPriorityColor(todo.Priority)" Variant="Variant.Text">
                                        @GetPriorityText(todo.Priority)
                                    </MudChip>
                                </div>
                                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(todo.Status)">
                                    @GetStatusText(todo.Status)
                                </MudChip>
                            </div>
                        </MudListItem>
                    }
                </MudPaper>
            </div>
        }

        <!-- é€¾æœŸå¾…è¾¦ -->
        @if (dashboard.OverdueItems.Count > 0)
        {
            <div>
                <MudText Typo="Typo.subtitle2" Color="Color.Error" Class="mb-2">âš ï¸ é€¾æœŸå¾…è¾¦</MudText>
                <MudPaper Elevation="0" Class="mud-list">
                    @foreach (var todo in dashboard.OverdueItems)
                    {
                        <MudListItem T="string" OnClick="@(() => NavigateToTodo(todo.Id))" Style="border-left: 3px solid var(--mud-palette-error)" Class="mud-list-item-clickable">
                            <div class="d-flex justify-space-between align-center">
                                <div style="flex: 1">
                                    <MudText Typo="Typo.body2">@todo.Title</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Error">
                                        é€¾æœŸ @(DateTime.Now - todo.DueDate!.Value).Days å¤©
                                    </MudText>
                                </div>
                                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(todo.Status)">
                                    @GetStatusText(todo.Status)
                                </MudChip>
                            </div>
                        </MudListItem>
                    }
                </MudPaper>
            </div>
        }

        @if (dashboard.DueTodayItems.Count == 0 && dashboard.OverdueItems.Count == 0)
        {
            <MudPaper Elevation="0" Class="pa-8 text-center" Style="background: rgba(76, 175, 80, 0.05)">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Large" Class="mb-2" />
                <MudText Typo="Typo.body1" Color="Color.Success">âœ… ç›®å‰æ²’æœ‰ç·Šæ€¥å¾…è¾¦äº‹é …</MudText>
            </MudPaper>
        }
    }
</MudPaper>

@code {
    private TodoDashboardResponse? dashboard;
    private bool loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboard();
    }

    private async Task LoadDashboard()
    {
        loading = true;
        dashboard = await TodoService.GetDashboardAsync();
        loading = false;
    }

    private async Task NavigateToTodo(int id)
    {
        var parameters = new DialogParameters<TodoDetailDialog>
        {
            { x => x.TodoId, id }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true
        };

        await DialogService.ShowAsync<TodoDetailDialog>("å¾…è¾¦äº‹é …è©³æƒ…", parameters, options);
        
        // é—œé–‰å°è©±æ¡†å¾Œé‡æ–°è¼‰å…¥å„€è¡¨æ¿ä»¥æ›´æ–°ç‹€æ…‹
        await LoadDashboard();
    }

    private Color GetPriorityColor(string priority) => priority switch
    {
        "High" => Color.Error,
        "Medium" => Color.Warning,
        "Low" => Color.Success,
        _ => Color.Default
    };

    private string GetPriorityText(string priority) => priority switch
    {
        "High" => "é«˜",
        "Medium" => "ä¸­",
        "Low" => "ä½",
        _ => priority
    };

    private Color GetStatusColor(string status) => status switch
    {
        "Pending" => Color.Default,
        "InProgress" => Color.Info,
        "Completed" => Color.Success,
        _ => Color.Default
    };

    private string GetStatusText(string status) => status switch
    {
        "Pending" => "å¾…è™•ç†",
        "InProgress" => "é€²è¡Œä¸­",
        "Completed" => "å·²å®Œæˆ",
        _ => status
    };
}
