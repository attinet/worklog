@page "/todos/create"
@page "/todos/edit/{Id:int}"
@using Microsoft.AspNetCore.Authorization
@using WorkLog.Shared.DTOs.Todos
@using WorkLog.Web.Services
@inject TodoService TodoService
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@attribute [Authorize]

<MudContainer MaxWidth="MaxWidth.Large" Class="py-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-4">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" 
                      Color="Color.Default" 
                      Variant="Variant.Outlined"
                      Size="Size.Medium"
                      OnClick="@(() => Cancel())" />
        <MudText Typo="Typo.h4" Style="font-weight: 600;">
            @(IsEditMode ? "編輯待辦事項" : "新增待辦事項")
        </MudText>
    </MudStack>

    @if (loading)
    {
        <MudPaper Elevation="2" Class="pa-8 text-center rounded-lg">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            <MudText Typo="Typo.body1" Class="mt-2">載入中...</MudText>
        </MudPaper>
    }
    else
    {
        <EditForm Model="@(IsEditMode ? (object)editModel : model)" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />
            
            <MudPaper Elevation="2" Class="pa-6 rounded-lg">
                <MudGrid Spacing="4">
                    <!-- 基本資訊區 -->
                    <MudItem xs="12">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-1">
                            <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" Color="Color.Primary" />
                            <MudText Typo="Typo.subtitle1" Color="Color.Primary" Style="font-weight: 600;">基本資訊</MudText>
                        </MudStack>
                        <MudDivider Class="mb-2" />
                    </MudItem>

                    <!--標題 -->
                    <MudItem xs="12">
                        @if (IsEditMode)
                        {
                            <MudTextField @bind-Value="editModel.Title" 
                                         Label="標題" 
                                         Variant="Variant.Outlined"
                                         Margin="Margin.Dense"
                                         Required="true"
                                         Placeholder="輸入待辦事項標題"
                                         Adornment="Adornment.Start"
                                         AdornmentIcon="@Icons.Material.Filled.Title" />
                        }
                        else
                        {
                            <MudTextField @bind-Value="model.Title" 
                                         Label="標題" 
                                         Variant="Variant.Outlined"
                                         Margin="Margin.Dense"
                                         Required="true"
                                         Placeholder="輸入待辦事項標題"
                                         Adornment="Adornment.Start"
                                         AdornmentIcon="@Icons.Material.Filled.Title" />
                        }
                    </MudItem>

                    <!-- 描述 -->
                    <MudItem xs="12">
                        @if (IsEditMode)
                        {
                            <MudTextField @bind-Value="editModel.Description" 
                                         Label="描述" 
                                         Variant="Variant.Outlined"
                                         Margin="Margin.Dense"
                                         Lines="4"
                                         Placeholder="詳細描述..." />
                        }
                        else
                        {
                            <MudTextField @bind-Value="model.Description" 
                                         Label="描述" 
                                         Variant="Variant.Outlined"
                                         Margin="Margin.Dense"
                                         Lines="4"
                                         Placeholder="詳細描述..." />
                        }
                    </MudItem>

                    <!-- 設定區 -->
                    <MudItem xs="12">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-1">
                            <MudIcon Icon="@Icons.Material.Filled.Settings" Size="Size.Small" Color="Color.Primary" />
                            <MudText Typo="Typo.subtitle1" Color="Color.Primary" Style="font-weight: 600;">設定</MudText>
                        </MudStack>
                        <MudDivider Class="mb-2" />
                    </MudItem>

                    <!-- 截止日期 -->
                    <MudItem xs="12" sm="6" md="4">
                        <Flatpickr @bind-Value="dueDate"
                                  Label="截止日期"
                                  DateFormat="Y/m/d"
                                  AdornmentIcon="@Icons.Material.Filled.CalendarToday" />
                    </MudItem>

                    <!-- 優先順序 -->
                    <MudItem xs="12" sm="6" md="4">
                        @if (IsEditMode)
                        {
                            <MudSelect T="string" 
                                      @bind-Value="editModel.Priority" 
                                      Label="優先順序" 
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Required="true"
                                      AdornmentIcon="@Icons.Material.Filled.Flag">
                                <MudSelectItem T="string" Value="@("Low")">低</MudSelectItem>
                                <MudSelectItem T="string" Value="@("Medium")">中</MudSelectItem>
                                <MudSelectItem T="string" Value="@("High")">高</MudSelectItem>
                            </MudSelect>
                        }
                        else
                        {
                            <MudSelect T="string" 
                                      @bind-Value="model.Priority" 
                                      Label="優先順序" 
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Required="true"
                                      AdornmentIcon="@Icons.Material.Filled.Flag">
                                <MudSelectItem T="string" Value="@("Low")">低</MudSelectItem>
                                <MudSelectItem T="string" Value="@("Medium")">中</MudSelectItem>
                                <MudSelectItem T="string" Value="@("High")">高</MudSelectItem>
                            </MudSelect>
                        }
                    </MudItem>

                    <!-- 狀態 (僅編輯模式) -->
                    @if (IsEditMode)
                    {
                        <MudItem xs="12" sm="6" md="4">
                            <MudSelect T="string" 
                                      @bind-Value="editModel.Status" 
                                      Label="狀態" 
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Required="true"
                                      AdornmentIcon="@Icons.Material.Filled.CheckCircle">
                                <MudSelectItem T="string" Value="@("Pending")">待處理</MudSelectItem>
                                <MudSelectItem T="string" Value="@("InProgress")">進行中</MudSelectItem>
                                <MudSelectItem T="string" Value="@("Completed")">已完成</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                    }

                    <!-- 分類 -->
                    <MudItem xs="12" sm="6" md="@(IsEditMode ? 12 : 4)">
                        @if (IsEditMode)
                        {
                            <MudSelect T="int?" 
                                      @bind-Value="editModel.CategoryId" 
                                      Label="分類" 
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Clearable="true"
                                      AdornmentIcon="@Icons.Material.Filled.Category">
                                @foreach (var category in categories)
                                {
                                    <MudSelectItem T="int?" Value="@((int?)category.Id)">@category.Name</MudSelectItem>
                                }
                            </MudSelect>
                        }
                        else
                        {
                            <MudSelect T="int?" 
                                      @bind-Value="model.CategoryId" 
                                      Label="分類" 
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Clearable="true"
                                      AdornmentIcon="@Icons.Material.Filled.Category">
                                @foreach (var category in categories)
                                {
                                    <MudSelectItem T="int?" Value="@((int?)category.Id)">@category.Name</MudSelectItem>
                                }
                            </MudSelect>
                        }
                    </MudItem>

                    <!-- 子任務 (僅新增模式) -->
                    @if (!IsEditMode)
                    {
                        <MudItem xs="12">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-1">
                                <MudIcon Icon="@Icons.Material.Filled.Checklist" Size="Size.Small" Color="Color.Primary" />
                                <MudText Typo="Typo.subtitle1" Color="Color.Primary" Style="font-weight: 600;">子任務</MudText>
                            </MudStack>
                            <MudDivider Class="mb-3" />
                            @foreach (var (subTask, index) in model.SubTasks.Select((st, i) => (st, i)))
                            {
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mb-2">
                                    <MudTextField @bind-Value="subTask.Title" 
                                                 Variant="Variant.Outlined" 
                                                 Margin="Margin.Dense"
                                                 Placeholder="子任務標題" 
                                                 Class="flex-grow-1"
                                                 Adornment="Adornment.Start"
                                                 AdornmentIcon="@Icons.Material.Filled.SubdirectoryArrowRight" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                  Color="Color.Error" 
                                                  Size="Size.Small"
                                                  Variant="Variant.Outlined"
                                                  OnClick="@(() => RemoveSubTask(index))" />
                                </MudStack>
                            }
                            <MudButton Variant="Variant.Text" 
                                      Color="Color.Primary" 
                                      StartIcon="@Icons.Material.Filled.Add"
                                      OnClick="@(() => AddSubTask())">
                                新增子任務
                            </MudButton>
                        </MudItem>
                    }
                </MudGrid>

                @if (errorMessage != null)
                {
                    <MudAlert Severity="Severity.Error" Class="mt-4">@errorMessage</MudAlert>
                }

                <!-- 按鈕 -->
                <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-6">
                    <MudButton Variant="Variant.Outlined" 
                              OnClick="@(() => Cancel())"
                              StartIcon="@Icons.Material.Filled.Close">
                        取消
                    </MudButton>
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              ButtonType="ButtonType.Submit"
                              Disabled="@submitting"
                              StartIcon="@Icons.Material.Filled.Save">
                        @(submitting ? "儲存中..." : "儲存")
                    </MudButton>
                </MudStack>
            </MudPaper>
        </EditForm>

        <!-- 編輯模式下的子任務管理 -->
        @if (IsEditMode && existingTodo != null)
        {
            <MudPaper Elevation="2" Class="pa-6 mt-4 rounded-lg">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-4">
                    <MudIcon Icon="@Icons.Material.Filled.Checklist" Size="Size.Small" Color="Color.Primary" />
                    <MudText Typo="Typo.h6" Color="Color.Primary" Style="font-weight: 600;">子任務管理</MudText>
                    <MudSpacer />
                    <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">
                        @existingTodo.SubTasks.Count(st => st.IsCompleted) / @existingTodo.SubTasks.Count
                    </MudChip>
                </MudStack>
                
                <MudStack Spacing="2">
                    @foreach (var subTask in existingTodo.SubTasks.OrderBy(st => st.SortOrder))
                    {
                        <MudPaper Outlined="true" Class="pa-3 rounded-lg">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                <MudCheckBox T="bool" 
                                            Value="@subTask.IsCompleted" 
                                            ValueChanged="@(async (bool val) => await ToggleSubTask(subTask.Id, val))"
                                            Color="Color.Primary" />
                                <MudText Typo="Typo.body1" Class="flex-grow-1" 
                                        Style="@(subTask.IsCompleted ? "text-decoration: line-through; opacity: 0.5;" : "")">
                                    @subTask.Title
                                </MudText>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                              Color="Color.Error" 
                                              Size="Size.Small"
                                              OnClick="@(async () => await DeleteSubTask(subTask.Id))" />
                            </MudStack>
                        </MudPaper>
                    }
                </MudStack>

                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2" Class="mt-4">
                    <MudTextField @bind-Value="newSubTaskTitle" 
                                 Variant="Variant.Outlined" 
                                 Placeholder="新子任務標題"
                                 Class="flex-grow-1"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.Add" />
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Primary" 
                              OnClick="@(async () => await AddSubTaskToExisting())"
                              StartIcon="@Icons.Material.Filled.Add">
                        新增
                    </MudButton>
                </MudStack>
            </MudPaper>
        }
    }
</MudContainer>

@code {
    [Parameter] public int? Id { get; set; }

    private bool IsEditMode => Id.HasValue;
    private CreateTodoItemRequest model = new() { Priority = "Medium" };
    private UpdateTodoItemRequest editModel = new() { Priority = "Medium", Status = "Pending" };
    private TodoItemResponse? existingTodo;
    private List<TodoCategoryResponse> categories = new();
    private bool loading = true;
    private bool submitting = false;
    private string? errorMessage;
    private string? newSubTaskTitle;
    private DateTime? dueDate;

    protected override async Task OnInitializedAsync()
    {
        await LoadCategories();
        
        if (IsEditMode && Id.HasValue)
        {
            await LoadTodo(Id.Value);
        }
        
        loading = false;
    }

    private async Task LoadCategories()
    {
        var result = await TodoService.GetCategoriesAsync();
        if (result != null)
        {
            categories = result;
        }
    }

    private async Task LoadTodo(int id)
    {
        existingTodo = await TodoService.GetTodoByIdAsync(id);
        if (existingTodo != null)
        {
            editModel.Title = existingTodo.Title;
            editModel.Description = existingTodo.Description;
            editModel.DueDate = existingTodo.DueDate;
            editModel.Priority = existingTodo.Priority;
            editModel.Status = existingTodo.Status;
            editModel.CategoryId = existingTodo.Category?.Id;
            
            dueDate = existingTodo.DueDate;
        }
    }

    private async Task HandleSubmit()
    {
        submitting = true;
        errorMessage = null;

        try
        {
            if (IsEditMode)
            {
                editModel.DueDate = dueDate;
            }
            else
            {
                model.DueDate = dueDate;
            }

            if (IsEditMode && Id.HasValue)
            {
                var success = await TodoService.UpdateTodoAsync(Id.Value, editModel);
                if (success)
                {
                    Snackbar.Add("更新成功", Severity.Success);
                    Navigation.NavigateTo("/todos");
                }
                else
                {
                    errorMessage = "更新失敗，請稍後再試";
                    Snackbar.Add(errorMessage, Severity.Error);
                }
            }
            else
            {
                // 清理子任務的序號
                for (int i = 0; i < model.SubTasks.Count; i++)
                {
                    model.SubTasks[i].SortOrder = i + 1;
                }

                var result = await TodoService.CreateTodoAsync(model);
                if (result != null)
                {
                    Snackbar.Add("建立成功", Severity.Success);
                    Navigation.NavigateTo("/todos");
                }
                else
                {
                    errorMessage = "建立失敗，請稍後再試";
                    Snackbar.Add(errorMessage, Severity.Error);
                }
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"發生錯誤: {ex.Message}";
            Snackbar.Add(errorMessage, Severity.Error);
        }
        finally
        {
            submitting = false;
        }
    }

    private void AddSubTask()
    {
        model.SubTasks.Add(new CreateTodoSubTaskRequest { SortOrder = model.SubTasks.Count + 1 });
    }

    private void RemoveSubTask(int index)
    {
        model.SubTasks.RemoveAt(index);
    }

    private async Task AddSubTaskToExisting()
    {
        if (string.IsNullOrWhiteSpace(newSubTaskTitle) || !Id.HasValue) return;

        var request = new CreateTodoSubTaskRequest
        {
            Title = newSubTaskTitle,
            SortOrder = existingTodo?.SubTasks.Count + 1 ?? 1
        };

        var result = await TodoService.AddSubTaskAsync(Id.Value, request);
        if (result != null)
        {
            Snackbar.Add("子任務新增成功", Severity.Success);
            await LoadTodo(Id.Value);
            newSubTaskTitle = null;
        }
        else
        {
            Snackbar.Add("子任務新增失敗", Severity.Error);
        }
    }

    private async Task ToggleSubTask(int subTaskId, bool isCompleted)
    {
        if (!Id.HasValue || existingTodo == null) return;

        var subTask = existingTodo.SubTasks.FirstOrDefault(st => st.Id == subTaskId);
        if (subTask == null) return;

        var request = new UpdateTodoSubTaskRequest
        {
            Title = subTask.Title,
            IsCompleted = isCompleted,
            SortOrder = subTask.SortOrder
        };

        var success = await TodoService.UpdateSubTaskAsync(Id.Value, subTaskId, request);
        if (success)
        {
            await LoadTodo(Id.Value);
        }
        else
        {
            Snackbar.Add("更新失敗", Severity.Error);
        }
    }

    private async Task DeleteSubTask(int subTaskId)
    {
        if (!Id.HasValue) return;

        var success = await TodoService.DeleteSubTaskAsync(Id.Value, subTaskId);
        if (success)
        {
            Snackbar.Add("子任務已刪除", Severity.Success);
            await LoadTodo(Id.Value);
        }
        else
        {
            Snackbar.Add("刪除失敗", Severity.Error);
        }
    }

    private void Cancel() => Navigation.NavigateTo("/todos");
}
