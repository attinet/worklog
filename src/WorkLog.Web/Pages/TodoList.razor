@page "/todos"
@using Microsoft.AspNetCore.Authorization
@using WorkLog.Shared.DTOs.Todos
@using WorkLog.Web.Services
@inject TodoService TodoService
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@attribute [Authorize]

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
    <MudPaper Elevation="0" Class="mb-4">
        <div class="d-flex justify-space-between align-center">
            <MudText Typo="Typo.h4">待辦事項</MudText>
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      StartIcon="@Icons.Material.Filled.Add"
                      OnClick="NavigateToCreate">
                新增待辦
            </MudButton>
        </div>
    </MudPaper>

    @if (loading)
    {
        <MudPaper Elevation="2" Class="pa-8 text-center">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            <MudText Typo="Typo.body1" Class="mt-2">載入中...</MudText>
        </MudPaper>
    }
    else
    {
        <!-- 統計卡片 -->
        <MudGrid Class="mb-4">
            <MudItem xs="12" sm="4">
                <MudPaper Elevation="2" Class="pa-4" Style="border-left: 4px solid #9e9e9e">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">待處理</MudText>
                    <MudText Typo="Typo.h4">@stats.PendingCount</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudPaper Elevation="2" Class="pa-4" Style="border-left: 4px solid var(--mud-palette-info)">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">進行中</MudText>
                    <MudText Typo="Typo.h4" Color="Color.Info">@stats.InProgressCount</MudText>
                </MudPaper>
            </MudItem>
            <MudItem xs="12" sm="4">
                <MudPaper Elevation="2" Class="pa-4" Style="border-left: 4px solid var(--mud-palette-success)">
                    <MudText Typo="Typo.caption" Color="Color.Secondary">已完成</MudText>
                    <MudText Typo="Typo.h4" Color="Color.Success">@stats.CompletedCount</MudText>
                </MudPaper>
            </MudItem>
        </MudGrid>

        <!-- 篩選列 -->
        <MudPaper Elevation="2" Class="pa-4 mb-4">
            <MudGrid>
                <MudItem xs="12" sm="6" md="3">
                    <MudSelect T="string" 
                              Value="@query.Status" 
                              Label="狀態" 
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Clearable="true"
                              ValueChanged="@(async (string val) => { query.Status = val; await LoadTodos(); })">
                        <MudSelectItem T="string" Value="@("")">全部</MudSelectItem>
                        <MudSelectItem T="string" Value="@("Pending")">待處理</MudSelectItem>
                        <MudSelectItem T="string" Value="@("InProgress")">進行中</MudSelectItem>
                        <MudSelectItem T="string" Value="@("Completed")">已完成</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudSelect T="string" 
                              Value="@query.Priority" 
                              Label="優先順序" 
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Clearable="true"
                              ValueChanged="@(async (string val) => { query.Priority = val; await LoadTodos(); })">
                        <MudSelectItem T="string" Value="@("")">全部</MudSelectItem>
                        <MudSelectItem T="string" Value="@("High")">高</MudSelectItem>
                        <MudSelectItem T="string" Value="@("Medium")">中</MudSelectItem>
                        <MudSelectItem T="string" Value="@("Low")">低</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" sm="6" md="4">
                    <MudTextField @bind-Value="query.Keyword" 
                                 Label="關鍵字" 
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 Placeholder="搜尋標題..."
                                 Immediate="true"
                                 DebounceInterval="500"
                                 OnDebounceIntervalElapsed="@(async (string _) => await LoadTodos())" />
                </MudItem>
                <MudItem xs="12" sm="6" md="2" Class="d-flex align-end">
                    <MudButton Variant="Variant.Outlined" 
                              OnClick="ResetFilters"
                              FullWidth="true"
                              StartIcon="@Icons.Material.Filled.FilterAltOff">
                        清除篩選
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <!-- 待辦事項清單 -->
        @if (todos.Count == 0)
        {
            <MudPaper Elevation="2" Class="pa-8 text-center">
                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Large" Color="Color.Secondary" Class="mb-2" />
                <MudText Typo="Typo.body1" Color="Color.Secondary">沒有待辦事項</MudText>
            </MudPaper>
        }
        else
        {
            <MudGrid>
                @foreach (var todo in todos)
                {
                    var currentTodo = todo;
                    <MudItem xs="12" sm="6" lg="4">
                        <MudCard Outlined="true" Style="@(currentTodo.IsOverdue ? "border-left: 4px solid var(--mud-palette-error)" : "")">
                            <MudCardContent>
                                <div @onclick="() => NavigateToDetail(currentTodo.Id)" style="cursor: pointer;">
                                    <div class="d-flex justify-space-between align-start mb-2">
                                        <MudText Typo="Typo.h6" Class="flex-grow-1">@currentTodo.Title</MudText>
                                        <MudChip T="string" Size="Size.Small" Color="@GetPriorityColor(currentTodo.Priority)" Class="ml-2">
                                            @GetPriorityText(currentTodo.Priority)
                                        </MudChip>
                                    </div>
                                    
                                    @if (currentTodo.Category != null)
                                    {
                                        <div class="mb-2">
                                            <MudChip T="string" Size="Size.Small" Style="@($"background-color: {currentTodo.Category.ColorCode}; color: white;")">
                                                @currentTodo.Category.Name
                                            </MudChip>
                                        </div>
                                    }

                                    @if (currentTodo.DueDate.HasValue)
                                    {
                                        <MudText Typo="Typo.body2" Color="@(currentTodo.IsOverdue ? Color.Error : Color.Secondary)" Class="mb-2">
                                            <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" /> 
                                            @currentTodo.DueDate.Value.ToString("yyyy/MM/dd")
                                            @if (currentTodo.IsOverdue)
                                            {
                                                <strong>（逾期）</strong>
                                            }
                                        </MudText>
                                    }

                                    <MudStack Row="true" Spacing="2" Class="mb-2">
                                        @if (currentTodo.SubTaskCount > 0)
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" /> 
                                                @currentTodo.CompletedSubTaskCount/@currentTodo.SubTaskCount
                                            </MudText>
                                        }
                                        @if (currentTodo.AttachmentCount > 0)
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                <MudIcon Icon="@Icons.Material.Filled.AttachFile" Size="Size.Small" /> 
                                                @currentTodo.AttachmentCount
                                            </MudText>
                                        }
                                    @if (currentTodo.CommentCount > 0)
                                    {
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                                            <MudIcon Icon="@Icons.Material.Filled.Comment" Size="Size.Small" /> 
                                            @currentTodo.CommentCount
                                        </MudText>
                                    }
                                </MudStack>

                                <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(currentTodo.Status)">
                                    @GetStatusText(currentTodo.Status)
                                </MudChip>
                            </div>

                            <div class="d-flex justify-end mt-2">
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                              Color="Color.Error" 
                                              Size="Size.Small"
                                              OnClick="@(() => DeleteTodo(currentTodo.Id))" />
                            </div>
                            </MudCardContent>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>

            <!-- 分頁 -->
            @if (totalPages > 1)
            {
                <MudPaper Elevation="0" Class="d-flex justify-center mt-4">
                    <MudPagination Count="@totalPages" 
                                  Selected="@query.Page" 
                                  SelectedChanged="@(async (int page) => { query.Page = page; await LoadTodos(); })"
                                  ShowFirstButton="true"
                                  ShowLastButton="true" />
                </MudPaper>
            }
        }
    }
</MudContainer>

@code {
    private List<TodoItemListResponse> todos = new();
    private TodoQueryDto query = new() { PageSize = 12 };
    private int totalPages = 0;
    private bool loading = true;
    private (int PendingCount, int InProgressCount, int CompletedCount) stats = (0, 0, 0);

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(LoadTodos(), LoadDashboard());
    }

    private async Task LoadTodos()
    {
        loading = true;
        var result = await TodoService.GetTodosAsync(query);
        if (result != null)
        {
            todos = result.Items.ToList();
            totalPages = result.TotalPages;
        }
        loading = false;
    }

    private async Task LoadDashboard()
    {
        var dashboard = await TodoService.GetDashboardAsync();
        if (dashboard != null)
        {
            stats = (dashboard.PendingCount, dashboard.InProgressCount, dashboard.CompletedCount);
        }
    }

    private async Task DeleteTodo(int id)
    {
        bool? result = await DialogService.ShowMessageBox(
            "刪除確認", 
            "確定要刪除這個待辦事項嗎？", 
            yesText: "刪除", 
            cancelText: "取消");
        
        if (result != true) return;

        if (await TodoService.DeleteTodoAsync(id))
        {
            Snackbar.Add("刪除成功", Severity.Success);
            await Task.WhenAll(LoadTodos(), LoadDashboard());
        }
        else
        {
            Snackbar.Add("刪除失敗", Severity.Error);
        }
    }

    private async Task ResetFilters()
    {
        query.Status = null;
        query.Priority = null;
        query.Keyword = null;
        query.Page = 1;
        await LoadTodos();
    }

    private void NavigateToCreate() => Navigation.NavigateTo("/todos/create");
    
    private async Task NavigateToDetail(int id)
    {
        var parameters = new DialogParameters<TodoDetailDialog>
        {
            { x => x.TodoId, id }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true
        };

        await DialogService.ShowAsync<TodoDetailDialog>("待辦事項詳情", parameters, options);
        
        // 關閉對話框後重新載入資料以更新狀態
        await Task.WhenAll(LoadTodos(), LoadDashboard());
    }

    private Color GetPriorityColor(string priority) => priority switch
    {
        "High" => Color.Error,
        "Medium" => Color.Warning,
        "Low" => Color.Success,
        _ => Color.Default
    };

    private string GetPriorityText(string priority) => priority switch
    {
        "High" => "高",
        "Medium" => "中",
        "Low" => "低",
        _ => priority
    };

    private Color GetStatusColor(string status) => status switch
    {
        "Pending" => Color.Default,
        "InProgress" => Color.Info,
        "Completed" => Color.Success,
        _ => Color.Default
    };

    private string GetStatusText(string status) => status switch
    {
        "Pending" => "待處理",
        "InProgress" => "進行中",
        "Completed" => "已完成",
        _ => status
    };
}
