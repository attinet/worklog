@page "/data-import"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using WorkLog.Shared.DTOs.Export
@using WorkLog.Web.Services
@using System.Security.Claims
@inject DataExportService ExportService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize]

<div class="container mx-auto px-4 py-6 max-w-7xl">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">è³‡æ–™åŒ¯å…¥</h1>

    <!-- å…©æ¬„ä½ˆå±€ -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- å·¦å´ï¼šå·¥ä½œç´€éŒ„åŒ¯å…¥ -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex items-center mb-4">
                <div class="text-3xl mr-3">ğŸ“‹</div>
                <h2 class="text-xl font-semibold text-gray-800">å·¥ä½œç´€éŒ„åŒ¯å…¥</h2>
            </div>
            <p class="text-sm text-gray-600 mb-4">åŒ¯å…¥å·¥ä½œç´€éŒ„å’Œå¾…è¾¦äº‹é …å‚™ä»½æª”</p>

            <!-- æª”æ¡ˆä¸Šå‚³ -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡ ZIP æª”æ¡ˆ</label>
                <InputFile OnChange="HandleWorkLogFileSelected" accept=".zip" class="block w-full text-sm text-gray-500
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-md file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-50 file:text-blue-700
                    hover:file:bg-blue-100
                    cursor-pointer" />
                @if (worklogFile != null)
                {
                    <p class="mt-2 text-xs text-gray-600">
                        å·²é¸æ“‡ï¼š<span class="font-medium">@worklogFile.Name</span>
                        ï¼ˆ@FormatFileSize(worklogFile.Size)ï¼‰
                    </p>
                }
            </div>

            <!-- é©—è­‰æŒ‰éˆ• -->
            @if (worklogFile != null && worklogValidation == null && worklogImportResult == null)
            {
                <button @onclick="ValidateWorkLogFile" disabled="@isValidatingWorkLog"
                        class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-2 rounded-lg disabled:bg-gray-400 text-sm font-medium mb-2">
                    @if (isValidatingWorkLog)
                    {
                        <span>é©—è­‰ä¸­...</span>
                    }
                    else
                    {
                        <span>ğŸ” é©—è­‰æª”æ¡ˆ</span>
                    }
                </button>
            }

            <!-- é©—è­‰çµæœ -->
            @if (worklogValidation != null)
            {
                var result = worklogValidation;
                <div class="mt-4 p-3 rounded-md @(result.Success ? "bg-green-50 border border-green-200" : "bg-red-50 border border-red-200")">
                    <h3 class="font-semibold text-sm @(result.Success ? "text-green-800" : "text-red-800") mb-1">
                        @(result.Success ? "âœ“ é©—è­‰é€šé" : "âœ— é©—è­‰å¤±æ•—")
                    </h3>
                    <p class="text-xs @(result.Success ? "text-green-700" : "text-red-700")">@result.Message</p>
                    
                    @if (result.Errors.Any())
                    {
                        <ul class="text-xs text-red-600 mt-2 space-y-0.5">
                            @foreach (var error in result.Errors)
                            {
                                <li>â€¢ @error</li>
                            }
                        </ul>
                    }

                    @if (result.Success)
                    {
                        <div class="mt-3 flex space-x-2">
                            <button @onclick="ImportWorkLogFile" disabled="@isImportingWorkLog"
                                    class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg disabled:bg-gray-400 text-xs font-medium">
                                @(isImportingWorkLog ? "åŒ¯å…¥ä¸­..." : "ğŸ“¤ ç¢ºèªåŒ¯å…¥")
                            </button>
                            <button @onclick="ResetWorkLog" 
                                    class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-xs font-medium">
                                å–æ¶ˆ
                            </button>
                        </div>
                    }
                </div>
            }

            <!-- åŒ¯å…¥çµæœ -->
            @if (worklogImportResult != null)
            {
                var result = worklogImportResult;
                <div class="mt-4 p-3 rounded-md @(result.Success ? "bg-green-50 border border-green-200" : "bg-red-50 border border-red-200")">
                    <h3 class="font-semibold text-sm @(result.Success ? "text-green-800" : "text-red-800") mb-1">
                        @(result.Success ? "âœ“ åŒ¯å…¥æˆåŠŸ" : "âœ— åŒ¯å…¥å¤±æ•—")
                    </h3>
                    <p class="text-xs @(result.Success ? "text-green-700" : "text-red-700") mb-2">@result.Message</p>

                    @if (result.Success)
                    {
                        var stats = result.Statistics;
                        <div class="bg-white rounded p-2 space-y-1 text-xs">
                            <div class="flex justify-between">
                                <span>å·¥ä½œç´€éŒ„ï¼š</span>
                                <span class="text-green-600 font-medium">@stats.WorkLogsImported ç­†</span>
                            </div>
                            <div class="flex justify-between">
                                <span>å¾…è¾¦äº‹é …ï¼š</span>
                                <span class="text-green-600 font-medium">@stats.TodosImported ç­†</span>
                            </div>
                        </div>

                        <div class="mt-3 flex space-x-2">
                            <button @onclick="NavigateToHome" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-xs font-medium">
                                è¿”å›é¦–é 
                            </button>
                            <button @onclick="ResetWorkLog" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-xs font-medium">
                                å†æ¬¡åŒ¯å…¥
                            </button>
                        </div>
                    }

                    @if (result.Errors.Any())
                    {
                        <ul class="text-xs text-red-600 mt-2 space-y-0.5 max-h-32 overflow-y-auto">
                            @foreach (var error in result.Errors)
                            {
                                <li>â€¢ @error</li>
                            }
                        </ul>
                    }
                </div>
            }

            <!-- èªªæ˜ -->
            <div class="mt-4 bg-blue-50 border border-blue-200 rounded p-3">
                <p class="text-xs text-blue-800 font-medium mb-1">æ³¨æ„äº‹é …ï¼š</p>
                <ul class="text-xs text-blue-700 space-y-0.5">
                    <li>â€¢ è³‡æ–™æœƒæ–°å¢åˆ°æ‚¨çš„å¸³è™Ÿä¸­</li>
                    <li>â€¢ ä¸æœƒåˆªé™¤ç¾æœ‰è³‡æ–™</li>
                    <li>â€¢ å¤±æ•—æ™‚æœƒè‡ªå‹•å›æ»¾</li>
                    <li>â€¢ æª”æ¡ˆé™åˆ¶ 50 MB</li>
                </ul>
            </div>
        </div>

        <!-- å³å´ï¼šç³»çµ±ç®¡ç†è³‡æ–™åŒ¯å…¥ -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex items-center mb-4">
                <div class="text-3xl mr-3">âš™ï¸</div>
                <h2 class="text-xl font-semibold text-gray-800">ç³»çµ±ç®¡ç†è³‡æ–™åŒ¯å…¥</h2>
            </div>
            <p class="text-sm text-gray-600 mb-4">åŒ¯å…¥ç³»çµ±è¨­å®šèˆ‡åƒç…§è³‡æ–™</p>

            @if (isAdmin)
            {
                <!-- æª”æ¡ˆä¸Šå‚³ -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">é¸æ“‡ ZIP æª”æ¡ˆ</label>
                    <InputFile OnChange="HandleSystemFileSelected" accept=".zip" class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-md file:border-0
                        file:text-sm file:font-semibold
                        file:bg-purple-50 file:text-purple-700
                        hover:file:bg-purple-100
                        cursor-pointer" />
                    @if (systemFile != null)
                    {
                        <p class="mt-2 text-xs text-gray-600">
                            å·²é¸æ“‡ï¼š<span class="font-medium">@systemFile.Name</span>
                            ï¼ˆ@FormatFileSize(systemFile.Size)ï¼‰
                        </p>
                    }
                </div>

                <!-- é©—è­‰æŒ‰éˆ• -->
                @if (systemFile != null && systemValidation == null && systemImportResult == null)
                {
                    <button @onclick="ValidateSystemFile" disabled="@isValidatingSystem"
                            class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-2 rounded-lg disabled:bg-gray-400 text-sm font-medium mb-2">
                        @if (isValidatingSystem)
                        {
                            <span>é©—è­‰ä¸­...</span>
                        }
                        else
                        {
                            <span>ğŸ” é©—è­‰æª”æ¡ˆ</span>
                        }
                    </button>
                }

                <!-- é©—è­‰çµæœ -->
                @if (systemValidation != null)
                {
                    var result = systemValidation;
                    <div class="mt-4 p-3 rounded-md @(result.Success ? "bg-green-50 border border-green-200" : "bg-red-50 border border-red-200")">
                        <h3 class="font-semibold text-sm @(result.Success ? "text-green-800" : "text-red-800") mb-1">
                            @(result.Success ? "âœ“ é©—è­‰é€šé" : "âœ— é©—è­‰å¤±æ•—")
                        </h3>
                        <p class="text-xs @(result.Success ? "text-green-700" : "text-red-700")">@result.Message</p>
                        
                        @if (result.Errors.Any())
                        {
                            <ul class="text-xs text-red-600 mt-2 space-y-0.5">
                                @foreach (var error in result.Errors)
                                {
                                    <li>â€¢ @error</li>
                                }
                            </ul>
                        }

                        @if (result.Success)
                        {
                            <div class="mt-3 flex space-x-2">
                                <button @onclick="ImportSystemFile" disabled="@isImportingSystem"
                                        class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg disabled:bg-gray-400 text-xs font-medium">
                                    @(isImportingSystem ? "åŒ¯å…¥ä¸­..." : "ğŸ“¤ ç¢ºèªåŒ¯å…¥")
                                </button>
                                <button @onclick="ResetSystem" 
                                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-xs font-medium">
                                    å–æ¶ˆ
                                </button>
                            </div>
                        }
                    </div>
                }

                <!-- åŒ¯å…¥çµæœ -->
                @if (systemImportResult != null)
                {
                    var result = systemImportResult;
                    <div class="mt-4 p-3 rounded-md @(result.Success ? "bg-green-50 border border-green-200" : "bg-red-50 border border-red-200")">
                        <h3 class="font-semibold text-sm @(result.Success ? "text-green-800" : "text-red-800") mb-1">
                            @(result.Success ? "âœ“ åŒ¯å…¥æˆåŠŸ" : "âœ— åŒ¯å…¥å¤±æ•—")
                        </h3>
                        <p class="text-xs @(result.Success ? "text-green-700" : "text-red-700") mb-2">@result.Message</p>

                        @if (result.Success)
                        {
                            var stats = result.Statistics;
                            <div class="bg-white rounded p-2 space-y-1 text-xs">
                                <div class="flex justify-between">
                                    <span>å°ˆæ¡ˆï¼š</span>
                                    <span class="font-medium">+@stats.ProjectsCreated / â†·@stats.ProjectsSkipped</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>éƒ¨é–€ï¼š</span>
                                    <span class="font-medium">+@stats.DepartmentsCreated / â†·@stats.DepartmentsSkipped</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>å·¥ä½œé¡å‹ï¼š</span>
                                    <span class="font-medium">+@stats.WorkTypesCreated / â†·@stats.WorkTypesSkipped</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>è™•ç†ç‹€æ…‹ï¼š</span>
                                    <span class="font-medium">+@stats.ProcessStatusesCreated / â†·@stats.ProcessStatusesSkipped</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>å¾…è¾¦åˆ†é¡ï¼š</span>
                                    <span class="font-medium">+@stats.TodoCategoriesCreated / â†·@stats.TodoCategoriesSkipped</span>
                                </div>
                            </div>

                            <div class="mt-3">
                                <button @onclick="ResetSystem" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-xs font-medium">
                                    å†æ¬¡åŒ¯å…¥
                                </button>
                            </div>
                        }

                        @if (result.Errors.Any())
                        {
                            <ul class="text-xs text-red-600 mt-2 space-y-0.5 max-h-32 overflow-y-auto">
                                @foreach (var error in result.Errors)
                                {
                                    <li>â€¢ @error</li>
                                }
                            </ul>
                        }
                    </div>
                }

                <!-- èªªæ˜ -->
                <div class="mt-4 bg-purple-50 border border-purple-200 rounded p-3">
                    <p class="text-xs text-purple-800 font-medium mb-1">æ³¨æ„äº‹é …ï¼š</p>
                    <ul class="text-xs text-purple-700 space-y-0.5">
                        <li>â€¢ åƒ…åŒ¯å…¥ç³»çµ±è¨­å®šè³‡æ–™</li>
                        <li>â€¢ åŒåé …ç›®æœƒè¢«è·³é</li>
                        <li>â€¢ å»ºè­°å…ˆåœ¨æ¸¬è©¦ç’°å¢ƒé©—è­‰</li>
                        <li>â€¢ æª”æ¡ˆé™åˆ¶ 10 MB</li>
                    </ul>
                </div>
            }
            else
            {
                <div class="bg-gray-50 border border-gray-200 rounded p-4 text-center">
                    <div class="text-4xl mb-2">ğŸ”’</div>
                    <p class="text-sm text-gray-600 font-medium">éœ€è¦ç®¡ç†å“¡æ¬Šé™</p>
                    <p class="text-xs text-gray-500 mt-1">
                        ç³»çµ±ç®¡ç†è³‡æ–™åŒ¯å…¥åŠŸèƒ½åƒ…é™ç®¡ç†å“¡ä½¿ç”¨
                    </p>
                </div>
            }
        </div>
    </div>
</div>


@code {
    // å·¥ä½œç´€éŒ„åŒ¯å…¥
    private IBrowserFile? worklogFile;
    private byte[]? worklogBytes;
    private bool isValidatingWorkLog = false;
    private bool isImportingWorkLog = false;
    private DataImportResultDto? worklogValidation;
    private DataImportResultDto? worklogImportResult;

    // ç³»çµ±è³‡æ–™åŒ¯å…¥
    private IBrowserFile? systemFile;
    private byte[]? systemBytes;
    private bool isValidatingSystem = false;
    private bool isImportingSystem = false;
    private DataImportResultDto? systemValidation;
    private DataImportResultDto? systemImportResult;

    // æ¬Šé™æª¢æŸ¥
    private bool isAdmin = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isAdmin = user.IsInRole("Admin");
    }

    // å·¥ä½œç´€éŒ„åŒ¯å…¥ç›¸é—œæ–¹æ³•
    private async Task HandleWorkLogFileSelected(InputFileChangeEventArgs e)
    {
        worklogFile = e.File;
        worklogBytes = null;
        worklogValidation = null;
        worklogImportResult = null;

        if (worklogFile != null)
        {
            if (worklogFile.Size > 522428800)
            {
                worklogValidation = new DataImportResultDto
                {
                    Success = false,
                    Errors = new List<string> { "æª”æ¡ˆå¤§å°ä¸å¯è¶…é 50 MB" }
                };
                worklogFile = null;
                return;
            }

            using var stream = worklogFile.OpenReadStream(maxAllowedSize: 52428800);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            worklogBytes = ms.ToArray();
        }
    }

    private async Task ValidateWorkLogFile()
    {
        if (worklogBytes == null) return;

        isValidatingWorkLog = true;
        try
        {
            worklogValidation = await ExportService.ValidateWorkLogImportFileAsync(worklogBytes);
        }
        catch (Exception ex)
        {
            worklogValidation = new DataImportResultDto
            {
                Success = false,
                Errors = new List<string> { $"é©—è­‰å¤±æ•—ï¼š{ex.Message}" }
            };
        }
        finally
        {
            isValidatingWorkLog = false;
        }
    }

    private async Task ImportWorkLogFile()
    {
        if (worklogBytes == null) return;

        isImportingWorkLog = true;
        try
        {
            worklogImportResult = await ExportService.ImportWorkLogDataAsync(worklogBytes);
        }
        catch (Exception ex)
        {
            worklogImportResult = new DataImportResultDto
            {
                Success = false,
                Errors = new List<string> { $"åŒ¯å…¥å¤±æ•—ï¼š{ex.Message}" }
            };
        }
        finally
        {
            isImportingWorkLog = false;
        }
    }

    private void ResetWorkLog()
    {
        worklogFile = null;
        worklogBytes = null;
        worklogValidation = null;
        worklogImportResult = null;
    }

    // ç³»çµ±è³‡æ–™åŒ¯å…¥ç›¸é—œæ–¹æ³•
    private async Task HandleSystemFileSelected(InputFileChangeEventArgs e)
    {
        systemFile = e.File;
        systemBytes = null;
        systemValidation = null;
        systemImportResult = null;

        if (systemFile != null)
        {
            if (systemFile.Size > 10485760)
            {
                systemValidation = new DataImportResultDto
                {
                    Success = false,
                    Errors = new List<string> { "æª”æ¡ˆå¤§å°ä¸å¯è¶…é 10 MB" }
                };
                systemFile = null;
                return;
            }

            using var stream = systemFile.OpenReadStream(maxAllowedSize: 10485760);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            systemBytes = ms.ToArray();
        }
    }

    private async Task ValidateSystemFile()
    {
        if (systemBytes == null) return;

        isValidatingSystem = true;
        try
        {
            systemValidation = await ExportService.ValidateSystemDataImportFileAsync(systemBytes);
        }
        catch (Exception ex)
        {
            systemValidation = new DataImportResultDto
            {
                Success = false,
                Errors = new List<string> { $"é©—è­‰å¤±æ•—ï¼š{ex.Message}" }
            };
        }
        finally
        {
            isValidatingSystem = false;
        }
    }

    private async Task ImportSystemFile()
    {
        if (systemBytes == null) return;

        isImportingSystem = true;
        try
        {
            systemImportResult = await ExportService.ImportSystemDataAsync(systemBytes);
        }
        catch (Exception ex)
        {
            systemImportResult = new DataImportResultDto
            {
                Success = false,
                Errors = new List<string> { $"åŒ¯å…¥å¤±æ•—ï¼š{ex.Message}" }
            };
        }
        finally
        {
            isImportingSystem = false;
        }
    }

    private void ResetSystem()
    {
        systemFile = null;
        systemBytes = null;
        systemValidation = null;
        systemImportResult = null;
    }

    // å…±ç”¨æ–¹æ³•
    private void NavigateToHome()
    {
        Navigation.NavigateTo("/");
    }

    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F2} KB";
        return $"{bytes / (1024.0 * 1024.0):F2} MB";
    }

    // å…§åµŒçµ„ä»¶é¡åˆ¥
    private class ImportResultComponent { }
    private class ImportSuccessComponent { }
}

<!-- ç°¡åŒ–çš„åŒ¯å…¥çµæœçµ„ä»¶ -->
@if (true) { }

@functions {
    private RenderFragment<(DataImportResultDto Result, bool IsImporting, EventCallback OnImport, EventCallback OnCancel)> WorkLogImportResult => context =>
    @<div class="mt-4 p-3 rounded-md @(context.Result.Success ? "bg-green-50 border border-green-200" : "bg-red-50 border border-red-200")">
        <h3 class="font-semibold text-sm @(context.Result.Success ? "text-green-800" : "text-red-800") mb-1">
            @(context.Result.Success ? "âœ“ é©—è­‰é€šé" : "âœ— é©—è­‰å¤±æ•—")
        </h3>
        <p class="text-xs @(context.Result.Success ? "text-green-700" : "text-red-700")">@context.Result.Message</p>
        
        @if (context.Result.Errors.Any())
        {
            <ul class="text-xs text-red-600 mt-2 space-y-0.5">
                @foreach (var error in context.Result.Errors)
                {
                    <li>â€¢ @error</li>
                }
            </ul>
        }

        @if (context.Result.Success)
        {
            <div class="mt-3 flex space-x-2">
                <button @onclick="context.OnImport" disabled="@context.IsImporting"
                        class="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg disabled:bg-gray-400 text-xs font-medium">
                    @(context.IsImporting ? "åŒ¯å…¥ä¸­..." : "ğŸ“¤ ç¢ºèªåŒ¯å…¥")
                </button>
                <button @onclick="context.OnCancel" 
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-xs font-medium">
                    å–æ¶ˆ
                </button>
            </div>
        }
    </div>;

    private RenderFragment<(DataImportResultDto Result, EventCallback OnReset, EventCallback OnNavigateHome)> WorkLogImportSuccess => context =>
    @<div class="mt-4 p-3 rounded-md @(context.Result.Success ? "bg-green-50 border border-green-200" : "bg-red-50 border border-red-200")">
        <h3 class="font-semibold text-sm @(context.Result.Success ? "text-green-800" : "text-red-800") mb-1">
            @(context.Result.Success ? "âœ“ åŒ¯å…¥æˆåŠŸ" : "âœ— åŒ¯å…¥å¤±æ•—")
        </h3>
        <p class="text-xs @(context.Result.Success ? "text-green-700" : "text-red-700") mb-2">@context.Result.Message</p>

        @if (context.Result.Success)
        {
            var stats = context.Result.Statistics;
            <div class="bg-white rounded p-2 space-y-1 text-xs">
                <div class="flex justify-between">
                    <span>å·¥ä½œç´€éŒ„ï¼š</span>
                    <span class="text-green-600 font-medium">@stats.WorkLogsImported ç­†</span>
                </div>
                <div class="flex justify-between">
                    <span>å¾…è¾¦äº‹é …ï¼š</span>
                    <span class="text-green-600 font-medium">@stats.TodosImported ç­†</span>
                </div>
            </div>

            <div class="mt-3 flex space-x-2">
                <button @onclick="context.OnNavigateHome" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-xs font-medium">
                    è¿”å›é¦–é 
                </button>
                <button @onclick="context.OnReset" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-xs font-medium">
                    å†æ¬¡åŒ¯å…¥
                </button>
            </div>
        }

        @if (context.Result.Errors.Any())
        {
            <ul class="text-xs text-red-600 mt-2 space-y-0.5 max-h-32 overflow-y-auto">
                @foreach (var error in context.Result.Errors)
                {
                    <li>â€¢ @error</li>
                }
            </ul>
        }
    </div>;

    private RenderFragment<(DataImportResultDto Result, bool IsImporting, EventCallback OnImport, EventCallback OnCancel)> SystemImportResult => context =>
    @<div class="mt-4 p-3 rounded-md @(context.Result.Success ? "bg-green-50 border border-green-200" : "bg-red-50 border border-red-200")">
        <h3 class="font-semibold text-sm @(context.Result.Success ? "text-green-800" : "text-red-800") mb-1">
            @(context.Result.Success ? "âœ“ é©—è­‰é€šé" : "âœ— é©—è­‰å¤±æ•—")
        </h3>
        <p class="text-xs @(context.Result.Success ? "text-green-700" : "text-red-700")">@context.Result.Message</p>
        
        @if (context.Result.Errors.Any())
        {
            <ul class="text-xs text-red-600 mt-2 space-y-0.5">
                @foreach (var error in context.Result.Errors)
                {
                    <li>â€¢ @error</li>
                }
            </ul>
        }

        @if (context.Result.Success)
        {
            <div class="mt-3 flex space-x-2">
                <button @onclick="context.OnImport" disabled="@context.IsImporting"
                        class="flex-1 bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg disabled:bg-gray-400 text-xs font-medium">
                    @(context.IsImporting ? "åŒ¯å…¥ä¸­..." : "ğŸ“¤ ç¢ºèªåŒ¯å…¥")
                </button>
                <button @onclick="context.OnCancel" 
                        class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-xs font-medium">
                    å–æ¶ˆ
                </button>
            </div>
        }
    </div>;

    private RenderFragment<(DataImportResultDto Result, EventCallback OnReset)> SystemImportSuccess => context =>
    @<div class="mt-4 p-3 rounded-md @(context.Result.Success ? "bg-green-50 border border-green-200" : "bg-red-50 border border-red-200")">
        <h3 class="font-semibold text-sm @(context.Result.Success ? "text-green-800" : "text-red-800") mb-1">
            @(context.Result.Success ? "âœ“ åŒ¯å…¥æˆåŠŸ" : "âœ— åŒ¯å…¥å¤±æ•—")
        </h3>
        <p class="text-xs @(context.Result.Success ? "text-green-700" : "text-red-700") mb-2">@context.Result.Message</p>

        @if (context.Result.Success)
        {
            var stats = context.Result.Statistics;
            <div class="bg-white rounded p-2 space-y-1 text-xs">
                <div class="flex justify-between">
                    <span>å°ˆæ¡ˆï¼š</span>
                    <span class="font-medium">+@stats.ProjectsCreated / â†·@stats.ProjectsSkipped</span>
                </div>
                <div class="flex justify-between">
                    <span>éƒ¨é–€ï¼š</span>
                    <span class="font-medium">+@stats.DepartmentsCreated / â†·@stats.DepartmentsSkipped</span>
                </div>
                <div class="flex justify-between">
                    <span>å·¥ä½œé¡å‹ï¼š</span>
                    <span class="font-medium">+@stats.WorkTypesCreated / â†·@stats.WorkTypesSkipped</span>
                </div>
                <div class="flex justify-between">
                    <span>è™•ç†ç‹€æ…‹ï¼š</span>
                    <span class="font-medium">+@stats.ProcessStatusesCreated / â†·@stats.ProcessStatusesSkipped</span>
                </div>
                <div class="flex justify-between">
                    <span>å¾…è¾¦åˆ†é¡ï¼š</span>
                    <span class="font-medium">+@stats.TodoCategoriesCreated / â†·@stats.TodoCategoriesSkipped</span>
                </div>
            </div>

            <div class="mt-3">
                <button @onclick="context.OnReset" class="w-full bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-xs font-medium">
                    å†æ¬¡åŒ¯å…¥
                </button>
            </div>
        }

        @if (context.Result.Errors.Any())
        {
            <ul class="text-xs text-red-600 mt-2 space-y-0.5 max-h-32 overflow-y-auto">
                @foreach (var error in context.Result.Errors)
                {
                    <li>â€¢ @error</li>
                }
            </ul>
        }
    </div>;
}