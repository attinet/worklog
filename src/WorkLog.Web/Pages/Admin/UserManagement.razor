@page "/admin/users"
@using Microsoft.AspNetCore.Authorization
@using WorkLog.Shared.DTOs
@using WorkLog.Shared.DTOs.Admin
@attribute [Authorize(Roles = "Admin")]
@inject HttpClient Http
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>使用者管理</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-6">
        <MudText Typo="Typo.h4">使用者權限管理</MudText>
        <MudStack Row="true" Spacing="2">
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      StartIcon="@Icons.Material.Filled.Add"
                      OnClick="@OpenCreateUserDialog">
                新增使用者
            </MudButton>
            <MudButton Variant="Variant.Outlined" 
                      StartIcon="@Icons.Material.Filled.ArrowBack"
                      Href="/admin">
                返回管理
            </MudButton>
        </MudStack>
    </MudStack>

    <MudPaper Elevation="2">
        <MudTable T="UserListItemDto" 
                 Items="@users" 
                 Loading="@isLoading"
                 Hover="true" 
                 Breakpoint="Breakpoint.Sm"
                 LoadingProgressColor="Color.Info">
            <HeaderContent>
                <MudTh>ID</MudTh>
                <MudTh>使用者名稱</MudTh>
                <MudTh>電子郵件</MudTh>
                <MudTh>角色</MudTh>
                <MudTh>註冊時間</MudTh>
                <MudTh Style="width: 200px;">操作</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="ID">@context.Id</MudTd>
                <MudTd DataLabel="使用者名稱">
                    <MudText Typo="Typo.body2" Class="font-weight-medium">@context.Username</MudText>
                </MudTd>
                <MudTd DataLabel="電子郵件">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">@context.Email</MudText>
                </MudTd>
                <MudTd DataLabel="角色">
                    <MudChip T="string" 
                            Size="Size.Small" 
                            Color="@(context.Role == "Admin" ? Color.Primary : Color.Default)">
                        @(context.Role == "Admin" ? "管理員" : "一般使用者")
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="註冊時間">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        @context.CreatedAt.ToLocalTime().ToString("yyyy-MM-dd")
                    </MudText>
                </MudTd>
                <MudTd DataLabel="操作">
                    <MudStack Row="true" Spacing="1">
                        @if (context.Role == "Admin")
                        {
                            <MudButton Size="Size.Small" 
                                      Variant="Variant.Text" 
                                      Color="Color.Warning"
                                      OnClick='@(() => ChangeRole(context.Id, "User"))'>
                                設為一般
                            </MudButton>
                        }
                        else
                        {
                            <MudButton Size="Size.Small" 
                                      Variant="Variant.Text" 
                                      Color="Color.Info"
                                      OnClick='@(() => ChangeRole(context.Id, "Admin"))'>
                                設為管理員
                            </MudButton>
                        }
                        <MudButton Size="Size.Small" 
                                  Variant="Variant.Text" 
                                  Color="Color.Success"
                                  StartIcon="@Icons.Material.Filled.Lock"
                                  OnClick="@(() => OpenChangePasswordDialog(context))">
                            改密碼
                        </MudButton>
                    </MudStack>
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="pa-4">
                    尚無使用者資料
                </MudText>
            </NoRecordsContent>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    private List<UserListItemDto> users = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        isLoading = true;
        try
        {
            var result = await Http.GetFromJsonAsync<List<UserListItemDto>>("api/admin/users");
            users = result ?? new();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"載入使用者列表失敗: {ex.Message}", Severity.Error);
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ChangeRole(int userId, string newRole)
    {
        try
        {
            var response = await Http.PutAsJsonAsync($"api/admin/users/{userId}/role",
                new ChangeRoleRequest { Role = newRole });
            
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("角色變更成功", Severity.Success);
                await LoadUsers();
            }
            else
            {
                Snackbar.Add("角色變更失敗", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"角色變更失敗: {ex.Message}", Severity.Error);
        }
    }

    private async Task OpenCreateUserDialog()
    {
        var parameters = new DialogParameters<CreateUserDialog>
        {
            { x => x.OnUserCreated, EventCallback.Factory.Create(this, LoadUsers) }
        };

        var options = new DialogOptions 
        { 
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        await DialogService.ShowAsync<CreateUserDialog>("新增使用者", parameters, options);
    }

    private async Task OpenChangePasswordDialog(UserListItemDto user)
    {
        var parameters = new DialogParameters<ChangePasswordDialog>
        {
            { x => x.UserId, user.Id },
            { x => x.Username, user.Username },
            { x => x.OnPasswordChanged, EventCallback.Factory.Create(this, async () => 
            {
                Snackbar.Add($"已成功修改 {user.Username} 的密碼", Severity.Success);
                await Task.CompletedTask;
            })}
        };

        var options = new DialogOptions 
        { 
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        await DialogService.ShowAsync<ChangePasswordDialog>("修改密碼", parameters, options);
    }
}
