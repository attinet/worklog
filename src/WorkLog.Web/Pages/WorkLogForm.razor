@page "/worklogs/create"
@page "/worklogs/{Id:int}/edit"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@inject HttpClient Http
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>@(IsEdit ? "編輯工作紀錄" : "新增工作紀錄")</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large">
    <div class="d-flex align-center mb-4">
        <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" 
                      Href="/" 
                      Color="Color.Default" />
        <MudText Typo="Typo.h4" Class="ml-2">@(IsEdit ? "編輯工作紀錄" : "新增工作紀錄")</MudText>
    </div>

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mb-4">@errorMessage</MudAlert>
    }

    <MudPaper Elevation="2" Class="pa-6">
        <EditForm Model="formModel" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary Class="mb-4" />

            <MudGrid>
                @* 標題 *@
                <MudItem xs="12">
                    <MudTextField @bind-Value="formModel.Title" 
                                 Label="標題" 
                                 Variant="Variant.Outlined"
                                 Required="true"
                                 For="@(() => formModel.Title)" />
                </MudItem>

                @* 紀錄日期 *@
                <MudItem xs="12" sm="6">
                    <MudDatePicker @bind-Date="recordDate" 
                                  Label="紀錄日期" 
                                  Variant="Variant.Outlined"
                                  DateFormat="yyyy-MM-dd"
                                  Required="true" />
                </MudItem>

                @* 專案名稱 *@
                <MudItem xs="12" sm="6">
                    <MudSelect @bind-Value="formModel.ProjectId" 
                              Label="專案名稱" 
                              Variant="Variant.Outlined"
                              Required="true"
                              T="int">
                        <MudSelectItem Value="0" Disabled="true">-- 請選擇 --</MudSelectItem>
                        @foreach (var p in projects)
                        {
                            <MudSelectItem Value="@p.Id">@p.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                @* 工時 *@
                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="formModel.WorkHours" 
                                    Label="工時（小時）" 
                                    Variant="Variant.Outlined"
                                    Step="0.5M"
                                    Min="0M"
                                    Required="true"
                                    T="decimal" />
                </MudItem>

                @* 處理狀態 *@
                <MudItem xs="12" sm="6">
                    <MudSelect @bind-Value="formModel.ProcessStatusId" 
                              Label="處理狀態" 
                              Variant="Variant.Outlined"
                              Required="true"
                              T="int">
                        <MudSelectItem Value="0" Disabled="true">-- 請選擇 --</MudSelectItem>
                        @foreach (var s in processStatuses)
                        {
                            <MudSelectItem Value="@s.Id">@s.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                @* 業管單位（複選） *@
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle2" Class="mb-2">
                        業管單位 
                        <span style="color: var(--mud-palette-error);">*</span>
                        （可複選，請至少選擇一個）
                    </MudText>
                    @if (departments.Count > 0)
                    {
                        <MudGrid>
                            @foreach (var dept in departments)
                            {
                                <MudItem xs="6" sm="4">
                                    <MudCheckBox Value="@CheckedDepartments[dept.Id]"
                                                ValueChanged="@((bool val) => OnDepartmentChanged(dept.Id, val))"
                                                Label="@dept.Name"
                                                Color="Color.Primary" />
                                </MudItem>
                            }
                        </MudGrid>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Warning" Class="mt-2">
                            尚未建立業管單位，請聯繫管理員
                        </MudAlert>
                    }
                </MudItem>

                @* 工作類型（複選） *@
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle2" Class="mb-2">
                        工作類型 
                        <span style="color: var(--mud-palette-error);">*</span>
                        （可複選，請至少選擇一個）
                    </MudText>
                    @if (workTypes.Count > 0)
                    {
                        <MudGrid>
                            @foreach (var wt in workTypes)
                            {
                                <MudItem xs="6" sm="4">
                                    <MudCheckBox Value="@CheckedWorkTypes[wt.Id]"
                                                ValueChanged="@((bool val) => OnWorkTypeChanged(wt.Id, val))"
                                                Label="@wt.Name"
                                                Color="Color.Primary" />
                                </MudItem>
                            }
                        </MudGrid>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Warning" Class="mt-2">
                            尚未建立工作類型，請聯繫管理員
                        </MudAlert>
                    }
                </MudItem>

                @* 內文 *@
                <MudItem xs="12">
                    <MudTextField @bind-Value="formModel.Content" 
                                 Label="內文" 
                                 Variant="Variant.Outlined"
                                 Lines="5"
                                 Required="true"
                                 For="@(() => formModel.Content)" />
                </MudItem>

                @* 按鈕 *@
                <MudItem xs="12" Class="d-flex gap-3 mt-2">
                    <MudButton ButtonType="ButtonType.Submit" 
                              Variant="Variant.Filled" 
                              Color="Color.Primary"
                              StartIcon="@Icons.Material.Filled.Save"
                              Disabled="@isSubmitting">
                        @(isSubmitting ? "儲存中..." : (IsEdit ? "更新" : "新增"))
                    </MudButton>
                    <MudButton Variant="Variant.Outlined" 
                              Color="Color.Default"
                              Href="/"
                              StartIcon="@Icons.Material.Filled.Cancel">
                        取消
                    </MudButton>
                </MudItem>
            </MudGrid>
        </EditForm>
    </MudPaper>
</MudContainer>

@code {
    [Parameter] public int Id { get; set; }
    private bool IsEdit => Id > 0;

    private WorkLogRequest formModel = new() { RecordDate = DateOnly.FromDateTime(DateTime.Today) };
    private DateTime? recordDate = DateTime.Today;
    private List<LookupItemDto> projects = new();
    private List<LookupItemDto> departments = new();
    private List<LookupItemDto> workTypes = new();
    private List<LookupItemDto> processStatuses = new();
    private Dictionary<int, bool> CheckedDepartments = new();
    private Dictionary<int, bool> CheckedWorkTypes = new();
    private string? errorMessage;
    private bool isSubmitting;

    protected override async Task OnInitializedAsync()
    {
        await LoadLookups();

        // 初始化 checkbox 字典
        foreach (var dept in departments)
            CheckedDepartments[dept.Id] = false;
        foreach (var wt in workTypes)
            CheckedWorkTypes[wt.Id] = false;

        if (IsEdit)
        {
            try
            {
                var log = await Http.GetFromJsonAsync<WorkLogResponse>($"api/worklogs/{Id}");
                if (log != null)
                {
                    formModel = new WorkLogRequest
                    {
                        Title = log.Title,
                        Content = log.Content,
                        RecordDate = log.RecordDate,
                        WorkHours = log.WorkHours,
                        ProjectId = log.Project.Id,
                        ProcessStatusId = log.ProcessStatus.Id,
                        DepartmentIds = log.Departments.Select(d => d.Id).ToList(),
                        WorkTypeIds = log.WorkTypes.Select(w => w.Id).ToList()
                    };
                    
                    recordDate = log.RecordDate.ToDateTime(TimeOnly.MinValue);
                    
                    // 設定已選中的項目
                    foreach (var deptId in formModel.DepartmentIds)
                        if (CheckedDepartments.ContainsKey(deptId))
                            CheckedDepartments[deptId] = true;
                    
                    foreach (var wtId in formModel.WorkTypeIds)
                        if (CheckedWorkTypes.ContainsKey(wtId))
                            CheckedWorkTypes[wtId] = true;
                }
            }
            catch
            {
                errorMessage = "載入紀錄失敗";
            }
        }
    }

    private void OnDepartmentChanged(int deptId, bool isChecked)
    {
        CheckedDepartments[deptId] = isChecked;
        formModel.DepartmentIds = CheckedDepartments.Where(x => x.Value).Select(x => x.Key).ToList();
    }

    private void OnWorkTypeChanged(int wtId, bool isChecked)
    {
        CheckedWorkTypes[wtId] = isChecked;
        formModel.WorkTypeIds = CheckedWorkTypes.Where(x => x.Value).Select(x => x.Key).ToList();
    }

    private async Task LoadLookups()
    {
        try
        {
            projects = await Http.GetFromJsonAsync<List<LookupItemDto>>("api/lookup/projects") ?? new();
            departments = await Http.GetFromJsonAsync<List<LookupItemDto>>("api/lookup/departments") ?? new();
            workTypes = await Http.GetFromJsonAsync<List<LookupItemDto>>("api/lookup/work-types") ?? new();
            processStatuses = await Http.GetFromJsonAsync<List<LookupItemDto>>("api/lookup/statuses") ?? new();
        }
        catch { }
    }

    private async Task HandleSubmit()
    {
        isSubmitting = true;
        errorMessage = null;

        // 轉換日期
        if (recordDate.HasValue)
            formModel.RecordDate = DateOnly.FromDateTime(recordDate.Value);

        try
        {
            HttpResponseMessage response;
            if (IsEdit)
                response = await Http.PutAsJsonAsync($"api/worklogs/{Id}", formModel);
            else
                response = await Http.PostAsJsonAsync("api/worklogs", formModel);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add(IsEdit ? "工作紀錄已更新" : "工作紀錄已新增", Severity.Success);
                Navigation.NavigateTo("/");
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                errorMessage = $"儲存失敗: {errorContent}";
                Snackbar.Add("儲存失敗，請檢查欄位是否填寫完整", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"發生錯誤: {ex.Message}";
            Snackbar.Add(errorMessage, Severity.Error);
        }

        isSubmitting = false;
    }
}
