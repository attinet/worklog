@page "/"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JS
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>工作紀錄</PageTitle>

<!-- 待辦事項儀表板 -->
<MudContainer MaxWidth="MaxWidth.False" Class="mb-4">
    <TodoDashboard />
</MudContainer>

<MudContainer MaxWidth="MaxWidth.False">
    <!-- 頂部操作列 -->
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h4">我的工作紀錄</MudText>
        <div class="d-flex gap-2">
            <MudButton Variant="Variant.Outlined" 
                      Color="Color.Secondary" 
                      StartIcon="@Icons.Material.Filled.Download"
                      OnClick="ExportToExcel"
                      Disabled="@isExporting">
                @(isExporting ? "匯出中..." : "匯出Excel")
            </MudButton>
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      StartIcon="@Icons.Material.Filled.Add"
                      Href="/worklogs/create">
                新增紀錄
            </MudButton>
        </div>
    </div>

    <!-- 篩選面板 -->
    <MudPaper Elevation="2" Class="pa-4 mb-4">
        <MudGrid>
            <MudItem xs="12" sm="6" md="3">
                <MudSelect Value="@selectedProjectId" 
                          Label="專案" 
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Clearable="true"
                          T="int?"
                          ValueChanged="@(async (int? val) => { selectedProjectId = val; await OnFilterChanged(); })">
                    @foreach (var p in projects)
                    {
                        <MudSelectItem Value="@((int?)p.Id)">@p.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudSelect Value="@selectedStatusId" 
                          Label="狀態" 
                          Variant="Variant.Outlined"
                          Margin="Margin.Dense"
                          Clearable="true"
                          T="int?"
                          ValueChanged="@(async (int? val) => { selectedStatusId = val; await OnFilterChanged(); })">
                    @foreach (var s in statuses)
                    {
                        <MudSelectItem Value="@((int?)s.Id)">@s.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudTextField @bind-Value="keyword" 
                             Label="關鍵字搜尋" 
                             Variant="Variant.Outlined"
                             Margin="Margin.Dense"
                             Placeholder="搜尋標題或內文..."
                             Immediate="true"
                             DebounceInterval="500"
                             OnDebounceIntervalElapsed="@(async (string _) => await OnFilterChanged())" />
            </MudItem>
            <MudItem xs="12" sm="6" md="2" Class="d-flex align-end">
                <MudButton Variant="Variant.Outlined" 
                          OnClick="ResetFilters"
                          FullWidth="true"
                          StartIcon="@Icons.Material.Filled.FilterAltOff">
                    清除篩選
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- 日曆 -->
    @if (isLoading)
    {
        <MudPaper Elevation="2" Class="pa-8 text-center mb-4">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            <MudText Typo="Typo.body1" Class="mt-2">載入中...</MudText>
        </MudPaper>
    }
    else
    {
        <MudPaper Elevation="2" Class="pa-4 mb-4">
            <Calendar CurrentMonth="@currentMonth"
                      WorkLogsByDate="@workLogsByDate"
                      SelectedDate="@selectedDate"
                      OnDateSelected="@OnDateSelected"
                      OnDateDoubleClicked="@OnDateDoubleClicked"
                      OnMonthChanged="@OnMonthChanged" />
        </MudPaper>
    }

    <!-- 選中日期的工作紀錄詳情 -->
    @if (selectedDate.HasValue && selectedDayLogs.Any())
    {
        <MudPaper Elevation="2" Class="pa-4">
            <div class="d-flex justify-space-between align-center mb-4">
                <MudText Typo="Typo.h6">
                    @selectedDate.Value.ToString("yyyy年 M月 d日") 的工作紀錄
                </MudText>
                <MudChip T="string" Color="Color.Info" Size="Size.Small">
                    共 @selectedDayLogs.Count 筆，合計 @selectedDayLogs.Sum(l => l.WorkHours).ToString("0.#") 小時
                </MudChip>
            </div>

            <MudStack Spacing="3">
                @foreach (var log in selectedDayLogs)
                {
                    <MudPaper Outlined="true" Class="pa-4">
                        <div class="d-flex justify-space-between align-start mb-2">
                            <div style="flex: 1">
                                <MudText Typo="Typo.h6" Class="mb-2">@log.Title</MudText>
                                <MudStack Row="true" Spacing="2" Class="mb-2">
                                    <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Folder" Color="Color.Default">
                                        @log.Project.Name
                                    </MudChip>
                                    <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.AccessTime" Color="Color.Default">
                                        @log.WorkHours.ToString("0.#") 小時
                                    </MudChip>
                                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(log.ProcessStatus.Name)">
                                        @log.ProcessStatus.Name
                                    </MudChip>
                                </MudStack>
                                @if (log.WorkTypes.Any())
                                {
                                    <MudStack Row="true" Spacing="1" Class="mb-2">
                                        @foreach (var type in log.WorkTypes)
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Primary" Variant="Variant.Text">@type.Name</MudChip>
                                        }
                                    </MudStack>
                                }
                                @if (log.Departments.Any())
                                {
                                    <MudStack Row="true" Spacing="1">
                                        @foreach (var dept in log.Departments)
                                        {
                                            <MudChip T="string" Size="Size.Small" Icon="@Icons.Material.Filled.Business" Color="Color.Default" Variant="Variant.Text">
                                                @dept.Name
                                            </MudChip>
                                        }
                                    </MudStack>
                                }
                            </div>
                            <MudStack Row="true" Spacing="2" Class="ml-4">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                              Color="Color.Primary" 
                                              Size="Size.Small"
                                              Href="@($"/worklogs/{log.Id}/edit")" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                              Color="Color.Error" 
                                              Size="Size.Small"
                                              OnClick="@(() => DeleteLog(log.Id))" />
                            </MudStack>
                        </div>
                        
                        @if (!string.IsNullOrEmpty(log.Content))
                        {
                            <MudDivider Class="my-2" />
                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                @log.Content
                            </MudText>
                        }
                    </MudPaper>
                }
            </MudStack>
        </MudPaper>
    }
    else if (selectedDate.HasValue && !selectedDayLogs.Any())
    {
        <MudPaper Elevation="2" Class="pa-8 text-center">
            <MudIcon Icon="@Icons.Material.Filled.EventBusy" Size="Size.Large" Color="Color.Secondary" Class="mb-2" />
            <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                @selectedDate.Value.ToString("yyyy年 M月 d日") 沒有工作紀錄
            </MudText>
            <MudButton Variant="Variant.Filled" 
                      Color="Color.Primary" 
                      StartIcon="@Icons.Material.Filled.Add"
                      Href="/worklogs/create">
                新增紀錄
            </MudButton>
        </MudPaper>
    }
</MudContainer>

@code {
    private Dictionary<DateOnly, List<WorkLogResponse>> workLogsByDate = new();
    private List<WorkLogResponse> selectedDayLogs = new();
    private List<LookupItemDto> projects = new();
    private List<LookupItemDto> statuses = new();
    private bool isLoading = true;
    private bool isExporting = false;

    private DateTime currentMonth = DateTime.Today;
    private DateOnly? selectedDate;
    private int? selectedProjectId;
    private int? selectedStatusId;
    private string? keyword;

    protected override async Task OnInitializedAsync()
    {
        await LoadLookups();
        await LoadMonthData();
    }

    private async Task LoadLookups()
    {
        try
        {
            projects = await Http.GetFromJsonAsync<List<LookupItemDto>>("api/lookup/projects") ?? new();
            statuses = await Http.GetFromJsonAsync<List<LookupItemDto>>("api/lookup/statuses") ?? new();
        }
        catch { }
    }

    private async Task LoadMonthData()
    {
        isLoading = true;
        try
        {
            // 查詢整月數據
            var monthStart = new DateOnly(currentMonth.Year, currentMonth.Month, 1);
            var monthEnd = monthStart.AddMonths(1).AddDays(-1);

            var url = $"api/worklogs?page=1&pageSize=1000&startDate={monthStart:yyyy-MM-dd}&endDate={monthEnd:yyyy-MM-dd}";
            
            // 添加篩選條件
            if (selectedProjectId.HasValue) 
                url += $"&projectId={selectedProjectId.Value}";
            if (selectedStatusId.HasValue) 
                url += $"&processStatusId={selectedStatusId.Value}";
            if (!string.IsNullOrWhiteSpace(keyword)) 
                url += $"&keyword={Uri.EscapeDataString(keyword)}";

            var response = await Http.GetFromJsonAsync<PagedResponse<WorkLogResponse>>(url);

            // 按日期分組
            if (response?.Items != null)
            {
                workLogsByDate = response.Items
                    .GroupBy(l => l.RecordDate)
                    .ToDictionary(g => g.Key, g => g.ToList());
            }
            else
            {
                workLogsByDate = new();
            }

            // 如果有選中的日期，更新該日的紀錄
            if (selectedDate.HasValue)
            {
                selectedDayLogs = workLogsByDate.GetValueOrDefault(selectedDate.Value, new());
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"載入月度數據失敗: {ex.Message}");
            workLogsByDate = new();
        }
        isLoading = false;
    }

    private async Task OnMonthChanged(DateTime newMonth)
    {
        currentMonth = newMonth;
        selectedDate = null;
        selectedDayLogs = new();
        await LoadMonthData();
    }

    private void OnDateSelected(DateOnly date)
    {
        selectedDate = date;
        selectedDayLogs = workLogsByDate.GetValueOrDefault(date, new());
    }

    private async Task OnDateDoubleClicked(DateOnly date)
    {
        var parameters = new DialogParameters<WorkLogFormDialog>
        {
            { x => x.SelectedDate, date }
        };

        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<WorkLogFormDialog>(
            $"新增 {date:yyyy年 M月 d日} 的工作紀錄",
            parameters,
            options
        );

        var result = await dialog.Result;

        if (result != null && !result.Canceled)
        {
            // 重新載入當月數據
            await LoadMonthData();
            
            // 重新選中該日期以顯示新增的紀錄
            selectedDate = date;
            selectedDayLogs = workLogsByDate.GetValueOrDefault(date, new());
        }
    }

    private async Task OnFilterChanged()
    {
        selectedDate = null;
        selectedDayLogs = new();
        await LoadMonthData();
    }

    private async Task DeleteLog(int id)
    {
        bool? result = await DialogService.ShowMessageBox(
            "刪除確認", 
            "確定要刪除這筆工作紀錄嗎？", 
            yesText: "刪除", 
            cancelText: "取消");
        
        if (result != true)
            return;

        try
        {
            var response = await Http.DeleteAsync($"api/worklogs/{id}");
            if (response.IsSuccessStatusCode)
            {
                await LoadMonthData();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"刪除失敗: {ex.Message}");
        }
    }

    private async Task ResetFilters()
    {
        selectedProjectId = null;
        selectedStatusId = null;
        keyword = null;
        selectedDate = null;
        selectedDayLogs = new();
        await LoadMonthData();
    }
async Task ExportToExcel()
    {
        isExporting = true;
        try
        {
            var year = currentMonth.Year;
            var month = currentMonth.Month;
            var url = $"api/worklogs/export?year={year}&month={month}";
            
            // 使用 HttpClient 取得檔案
            var response = await Http.GetAsync(url);
            if (response.IsSuccessStatusCode)
            {
                var fileBytes = await response.Content.ReadAsByteArrayAsync();
                var fileName = $"工作紀錄_{year}年{month:D2}月.xlsx";
                
                // 使用 JavaScript 下載檔案
                await DownloadFile(fileName, fileBytes);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"匯出失敗: {ex.Message}");
        }
        finally
        {
            isExporting = false;
        }
    }

    private async Task DownloadFile(string fileName, byte[] fileBytes)
    {
        var base64 = Convert.ToBase64String(fileBytes);
        await JS.InvokeVoidAsync("eval", $@"
            (function() {{
                const link = document.createElement('a');
                link.href = 'data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,{base64}';
                link.download = '{fileName}';
                link.click();
            }})();
        ");
    }

    private static string GetStatusBadgeClass(string status) => status switch
    {
        "已完成" => "badge-green",
        "處理中" => "badge-blue",
        "擱置"   => "badge-yellow",
        _        => "badge-gray"
    };

    private static Color GetStatusColor(string status) => status switch
    {
        "已完成" => Color.Success,
        "處理中" => Color.Info,
        "擱置"   => Color.Warning,
        _        => Color.Default
    };
}
