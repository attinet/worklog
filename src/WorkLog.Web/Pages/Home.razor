@page "/"
@attribute [Microsoft.AspNetCore.Authorization.Authorize]
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>工作紀錄</PageTitle>

<!-- 待辦事項儀表板 -->
<div class="mb-6">
    <TodoDashboard />
</div>

<div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-800">我的工作紀錄</h1>
    <div class="flex gap-2">
        <button @onclick="ExportToExcel" class="btn-secondary" disabled="@isExporting">
            @if (isExporting)
            {
                <span>匯出中...</span>
            }
            else
            {
                <span>📥 匯出Excel</span>
            }
        </button>
        <a href="/worklogs/create" class="btn-primary">+ 新增紀錄</a>
    </div>
</div>

@* 篩選面板 *@
<div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">專案</label>
            <InputSelect @bind-Value="selectedProjectId" class="input-field" @onchange="OnFilterChanged">
                <option value="">全部</option>
                @foreach (var p in projects)
                {
                    <option value="@p.Id">@p.Name</option>
                }
            </InputSelect>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">狀態</label>
            <InputSelect @bind-Value="selectedStatusId" class="input-field" @onchange="OnFilterChanged">
                <option value="">全部</option>
                @foreach (var s in statuses)
                {
                    <option value="@s.Id">@s.Name</option>
                }
            </InputSelect>
        </div>
        <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">關鍵字</label>
            <input type="text" @bind="keyword" @bind:event="oninput" placeholder="搜尋標題或內文..." class="input-field" />
        </div>
        <div class="flex items-end">
            <button @onclick="ResetFilters" class="btn-secondary w-full">清除篩選</button>
        </div>
    </div>
</div>

@* 日曆 *@
@if (isLoading)
{
    <div class="text-center py-10 text-gray-500">載入中...</div>
}
else
{
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-6">
        <Calendar CurrentMonth="@currentMonth"
                  WorkLogsByDate="@workLogsByDate"
                  SelectedDate="@selectedDate"
                  OnDateSelected="@OnDateSelected"
                  OnMonthChanged="@OnMonthChanged" />
    </div>
}

@* 選中日期的工作紀錄詳情 *@
@if (selectedDate.HasValue && selectedDayLogs.Any())
{
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold text-gray-800">
                @selectedDate.Value.ToString("yyyy年 M月 d日") 的工作紀錄
            </h3>
            <span class="text-sm text-gray-600">
                共 @selectedDayLogs.Count 筆，合計 @selectedDayLogs.Sum(l => l.WorkHours).ToString("0.#") 小時
            </span>
        </div>

        <div class="space-y-3">
            @foreach (var log in selectedDayLogs)
            {
                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <h4 class="font-semibold text-gray-900 mb-1">@log.Title</h4>
                            <div class="flex flex-wrap gap-2 text-xs text-gray-600 mb-2">
                                <span class="flex items-center gap-1">
                                    📁 @log.Project.Name
                                </span>
                                <span class="flex items-center gap-1">
                                    ⏱ @log.WorkHours.ToString("0.#") 小時
                                </span>
                                <span class="@GetStatusBadgeClass(log.ProcessStatus.Name)">
                                    @log.ProcessStatus.Name
                                </span>
                            </div>
                            @if (log.WorkTypes.Any())
                            {
                                <div class="flex flex-wrap gap-1 mb-2">
                                    @foreach (var type in log.WorkTypes)
                                    {
                                        <span class="text-xs px-2 py-1 bg-blue-50 text-blue-700 rounded">@type.Name</span>
                                    }
                                </div>
                            }
                            @if (log.Departments.Any())
                            {
                                <div class="flex flex-wrap gap-1">
                                    @foreach (var dept in log.Departments)
                                    {
                                        <span class="text-xs px-2 py-1 bg-gray-100 text-gray-700 rounded">🏢 @dept.Name</span>
                                    }
                                </div>
                            }
                        </div>
                        <div class="flex gap-2 ml-4">
                            <a href="/worklogs/@log.Id/edit" class="text-blue-600 hover:text-blue-800 text-sm font-medium">編輯</a>
                            <button @onclick="() => DeleteLog(log.Id)" class="text-red-500 hover:text-red-700 text-sm font-medium">刪除</button>
                        </div>
                    </div>
                    
                    @if (!string.IsNullOrEmpty(log.Content))
                    {
                        <div class="text-sm text-gray-600 mt-3 pt-3 border-t border-gray-100">
                            <div class="line-clamp-2">@log.Content</div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
}
else if (selectedDate.HasValue && !selectedDayLogs.Any())
{
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 text-center">
        <p class="text-gray-500">@selectedDate.Value.ToString("yyyy年 M月 d日") 沒有工作紀錄</p>
        <a href="/worklogs/create" class="btn-primary inline-block mt-4">新增紀錄</a>
    </div>
}

@code {
    private Dictionary<DateOnly, List<WorkLogResponse>> workLogsByDate = new();
    private List<WorkLogResponse> selectedDayLogs = new();
    private List<LookupItemDto> projects = new();
    private List<LookupItemDto> statuses = new();
    private bool isLoading = true;
    private bool isExporting = false;

    private DateTime currentMonth = DateTime.Today;
    private DateOnly? selectedDate;
    private int? selectedProjectId;
    private int? selectedStatusId;
    private string? keyword;

    protected override async Task OnInitializedAsync()
    {
        await LoadLookups();
        await LoadMonthData();
    }

    private async Task LoadLookups()
    {
        try
        {
            projects = await Http.GetFromJsonAsync<List<LookupItemDto>>("api/lookup/projects") ?? new();
            statuses = await Http.GetFromJsonAsync<List<LookupItemDto>>("api/lookup/statuses") ?? new();
        }
        catch { }
    }

    private async Task LoadMonthData()
    {
        isLoading = true;
        try
        {
            // 查詢整月數據
            var monthStart = new DateOnly(currentMonth.Year, currentMonth.Month, 1);
            var monthEnd = monthStart.AddMonths(1).AddDays(-1);

            var url = $"api/worklogs?page=1&pageSize=1000&startDate={monthStart:yyyy-MM-dd}&endDate={monthEnd:yyyy-MM-dd}";
            
            // 添加篩選條件
            if (selectedProjectId.HasValue) 
                url += $"&projectId={selectedProjectId.Value}";
            if (selectedStatusId.HasValue) 
                url += $"&processStatusId={selectedStatusId.Value}";
            if (!string.IsNullOrWhiteSpace(keyword)) 
                url += $"&keyword={Uri.EscapeDataString(keyword)}";

            var response = await Http.GetFromJsonAsync<PagedResponse<WorkLogResponse>>(url);

            // 按日期分組
            if (response?.Items != null)
            {
                workLogsByDate = response.Items
                    .GroupBy(l => l.RecordDate)
                    .ToDictionary(g => g.Key, g => g.ToList());
            }
            else
            {
                workLogsByDate = new();
            }

            // 如果有選中的日期，更新該日的紀錄
            if (selectedDate.HasValue)
            {
                selectedDayLogs = workLogsByDate.GetValueOrDefault(selectedDate.Value, new());
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"載入月度數據失敗: {ex.Message}");
            workLogsByDate = new();
        }
        isLoading = false;
    }

    private async Task OnMonthChanged(DateTime newMonth)
    {
        currentMonth = newMonth;
        selectedDate = null;
        selectedDayLogs = new();
        await LoadMonthData();
    }

    private void OnDateSelected(DateOnly date)
    {
        selectedDate = date;
        selectedDayLogs = workLogsByDate.GetValueOrDefault(date, new());
    }

    private async Task OnFilterChanged()
    {
        selectedDate = null;
        selectedDayLogs = new();
        await LoadMonthData();
    }

    private async Task DeleteLog(int id)
    {
        if (!await ShowConfirm("確定要刪除這筆工作紀錄嗎？"))
            return;

        try
        {
            var response = await Http.DeleteAsync($"api/worklogs/{id}");
            if (response.IsSuccessStatusCode)
            {
                await LoadMonthData();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"刪除失敗: {ex.Message}");
        }
    }

    private async Task ResetFilters()
    {
        selectedProjectId = null;
        selectedStatusId = null;
        keyword = null;
        selectedDate = null;
        selectedDayLogs = new();
        await LoadMonthData();
    }
async Task ExportToExcel()
    {
        isExporting = true;
        try
        {
            var year = currentMonth.Year;
            var month = currentMonth.Month;
            var url = $"api/worklogs/export?year={year}&month={month}";
            
            // 使用 HttpClient 取得檔案
            var response = await Http.GetAsync(url);
            if (response.IsSuccessStatusCode)
            {
                var fileBytes = await response.Content.ReadAsByteArrayAsync();
                var fileName = $"工作紀錄_{year}年{month:D2}月.xlsx";
                
                // 使用 JavaScript 下載檔案
                await DownloadFile(fileName, fileBytes);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"匯出失敗: {ex.Message}");
        }
        finally
        {
            isExporting = false;
        }
    }

    private async Task DownloadFile(string fileName, byte[] fileBytes)
    {
        var base64 = Convert.ToBase64String(fileBytes);
        await JS.InvokeVoidAsync("eval", $@"
            (function() {{
                const link = document.createElement('a');
                link.href = 'data:application/vnd.openxmlformats-officedocument.spreadsheetml.sheet;base64,{base64}';
                link.download = '{fileName}';
                link.click();
            }})();
        ");
    }

    private static string GetStatusBadgeClass(string status) => status switch
    {
        "已完成" => "badge-green",
        "處理中" => "badge-blue",
        "擱置"   => "badge-yellow",
        _        => "badge-gray"
    };

    // 簡單的確認對話框（使用瀏覽器原生 confirm）
    private async Task<bool> ShowConfirm(string message)
    {
        // 在實際應用中，這裡可以使用更好的 UI 元件
        // 暫時返回 true，實際刪除前應該有確認機制
        return true;
    }
}
