@page "/data-export"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.JSInterop
@using WorkLog.Web.Services
@using System.Security.Claims
@inject DataExportService ExportService
@inject IJSRuntime JS
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ISnackbar Snackbar
@attribute [Authorize]

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
    <MudText Typo="Typo.h4" Class="mb-6">è³‡æ–™å‚™ä»½</MudText>

    <MudGrid Spacing="3" Class="mb-6">
        <!-- å·¦å´ï¼šå·¥ä½œç´€éŒ„å‚™ä»½ -->
        <MudItem xs="12" lg="6">
            <MudPaper Elevation="2" Class="pa-6">
                <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
                    <MudText Typo="Typo.h3">ğŸ“‹</MudText>
                    <MudText Typo="Typo.h6">å·¥ä½œç´€éŒ„å‚™ä»½</MudText>
                </MudStack>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                    åŒ¯å‡ºæ‚¨çš„å·¥ä½œç´€éŒ„å’Œå¾…è¾¦äº‹é …
                </MudText>

                <MudStack Spacing="3">
                    <!-- æ—¥æœŸç¯„åœ -->
                    <MudDatePicker @bind-Date="worklogStartDate" 
                                  Label="é–‹å§‹æ—¥æœŸï¼ˆé¸å¡«ï¼‰" 
                                  Variant="Variant.Outlined"
                                  Editable="true"
                                  DateFormat="yyyy/MM/dd" />
                    
                    <MudDatePicker @bind-Date="worklogEndDate" 
                                  Label="çµæŸæ—¥æœŸï¼ˆé¸å¡«ï¼‰" 
                                  Variant="Variant.Outlined"
                                  Editable="true"
                                  DateFormat="yyyy/MM/dd" />

                    <!-- åŒ…å«é™„ä»¶é¸é … -->
                    <MudCheckBox @bind-Value="worklogIncludeAttachments" 
                                Color="Color.Primary">
                        åŒ…å«é™„ä»¶æª”æ¡ˆ
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="ml-1" Style="display: inline;">
                            ï¼ˆå¾…è¾¦äº‹é …çš„é™„ä»¶æœƒå¢åŠ æª”æ¡ˆå¤§å°ï¼‰
                        </MudText>
                    </MudCheckBox>
                </MudStack>

                <!-- åŒ¯å‡ºæŒ‰éˆ• -->
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          FullWidth="true"
                          OnClick="@(async () => await ExportWorkLogData())"
                          Disabled="@isExportingWorkLog"
                          StartIcon="@Icons.Material.Filled.Download"
                          Class="mt-6">
                    @if (isExportingWorkLog)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>åŒ¯å‡ºä¸­...</span>
                    }
                    else
                    {
                        <span>åŒ¯å‡ºå·¥ä½œç´€éŒ„</span>
                    }
                </MudButton>

                <!-- èªªæ˜ -->
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true" Class="mt-4">
                    <MudText Typo="Typo.caption" Class="font-weight-bold mb-1">åŒ…å«å…§å®¹ï¼š</MudText>
                    <MudList Dense="true" Class="py-0">
                        <MudText Typo="Typo.caption">â€¢ å·¥ä½œç´€éŒ„æ¢ç›®</MudText>
                        <MudText Typo="Typo.caption">â€¢ å¾…è¾¦äº‹é …ï¼ˆå«å­ä»»å‹™ã€è©•è«–ï¼‰</MudText>
                        <MudText Typo="Typo.caption">â€¢ é™„ä»¶æª”æ¡ˆï¼ˆè‹¥å‹¾é¸ï¼‰</MudText>
                    </MudList>
                </MudAlert>
            </MudPaper>
        </MudItem>

        <!-- å³å´ï¼šç³»çµ±ç®¡ç†è³‡æ–™å‚™ä»½ -->
        <MudItem xs="12" lg="6">
            <MudPaper Elevation="2" Class="pa-6">
                <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
                    <MudText Typo="Typo.h3">âš™ï¸</MudText>
                    <MudText Typo="Typo.h6">ç³»çµ±ç®¡ç†è³‡æ–™å‚™ä»½</MudText>
                </MudStack>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                    åŒ¯å‡ºç³»çµ±è¨­å®šèˆ‡åƒç…§è³‡æ–™
                </MudText>

                @if (isAdmin)
                {
                    <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Dense="true" Class="mb-4">
                        <MudText Typo="Typo.caption" Class="font-weight-bold">ç®¡ç†å“¡åŠŸèƒ½</MudText>
                        <MudText Typo="Typo.caption">
                            æ­¤åŠŸèƒ½å°‡åŒ¯å‡ºæ‰€æœ‰ç³»çµ±è¨­å®šè³‡æ–™ï¼ŒåŒ…æ‹¬å°ˆæ¡ˆã€éƒ¨é–€ã€å·¥ä½œé¡å‹ã€è™•ç†ç‹€æ…‹å’Œå¾…è¾¦åˆ†é¡ã€‚
                        </MudText>
                    </MudAlert>

                    <!-- åŒ¯å‡ºæŒ‰éˆ• -->
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Secondary" 
                              FullWidth="true"
                              OnClick="@(async () => await ExportSystemData())"
                              Disabled="@isExportingSystem"
                              StartIcon="@Icons.Material.Filled.Download"
                              Class="mt-3">
                        @if (isExportingSystem)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>åŒ¯å‡ºä¸­...</span>
                        }
                        else
                        {
                            <span>åŒ¯å‡ºç³»çµ±è³‡æ–™</span>
                        }
                    </MudButton>

                    <!-- èªªæ˜ -->
                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true" Color="Color.Secondary" Class="mt-4">
                        <MudText Typo="Typo.caption" Class="font-weight-bold mb-1">åŒ…å«å…§å®¹ï¼š</MudText>
                        <MudList Dense="true" Class="py-0">
                            <MudText Typo="Typo.caption">â€¢ å°ˆæ¡ˆåç¨±æ¸…å–®</MudText>
                            <MudText Typo="Typo.caption">â€¢ æ¥­ç®¡å–®ä½æ¸…å–®</MudText>
                            <MudText Typo="Typo.caption">â€¢ å·¥ä½œé¡å‹æ¸…å–®</MudText>
                            <MudText Typo="Typo.caption">â€¢ è™•ç†ç‹€æ…‹æ¸…å–®</MudText>
                            <MudText Typo="Typo.caption">â€¢ å¾…è¾¦åˆ†é¡æ¸…å–®</MudText>
                        </MudList>
                    </MudAlert>
                }
                else
                {
                    <MudPaper Elevation="0" Class="pa-6 text-center" Style="background-color: var(--mud-palette-background-grey);">
                        <MudText Typo="Typo.h3" Class="mb-2">ğŸ”’</MudText>
                        <MudText Typo="Typo.body2" Class="font-weight-bold">éœ€è¦ç®¡ç†å“¡æ¬Šé™</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">
                            ç³»çµ±ç®¡ç†è³‡æ–™å‚™ä»½åŠŸèƒ½åƒ…é™ç®¡ç†å“¡ä½¿ç”¨
                        </MudText>
                    </MudPaper>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>

    <!-- å…¨åŸŸèªªæ˜ -->
    <MudPaper Elevation="1" Class="pa-4">
        <MudText Typo="Typo.h6" Class="mb-3">ğŸ’¡ å‚™ä»½èªªæ˜</MudText>
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudText Typo="Typo.body2" Class="font-weight-bold mb-2">å·¥ä½œç´€éŒ„å‚™ä»½</MudText>
                <MudList Dense="true" Class="py-0">
                    <MudText Typo="Typo.caption">â€¢ å±¬æ–¼å€‹äººè³‡æ–™å‚™ä»½</MudText>
                    <MudText Typo="Typo.caption">â€¢ å¯è¨­å®šæ—¥æœŸç¯„åœç¯©é¸</MudText>
                    <MudText Typo="Typo.caption">â€¢ æ”¯æ´é™„ä»¶åŒ¯å‡º</MudText>
                    <MudText Typo="Typo.caption">â€¢ æª”æ¡ˆè¼ƒå¤§ï¼ˆè¦–é™„ä»¶å¤šå¯¡ï¼‰</MudText>
                </MudList>
            </MudItem>
            <MudItem xs="12" md="6">
                <MudText Typo="Typo.body2" Class="font-weight-bold mb-2">ç³»çµ±ç®¡ç†è³‡æ–™å‚™ä»½</MudText>
                <MudList Dense="true" Class="py-0">
                    <MudText Typo="Typo.caption">â€¢ å±¬æ–¼ç³»çµ±è¨­å®šå‚™ä»½</MudText>
                    <MudText Typo="Typo.caption">â€¢ éœ€è¦ç®¡ç†å“¡æ¬Šé™</MudText>
                    <MudText Typo="Typo.caption">â€¢ ä¸å«å€‹äººè³‡æ–™</MudText>
                    <MudText Typo="Typo.caption">â€¢ æª”æ¡ˆè¼ƒå°ï¼ˆç´”æ–‡å­—è³‡æ–™ï¼‰</MudText>
                </MudList>
            </MudItem>
        </MudGrid>
    </MudPaper>
</MudContainer>

@code {
    // å·¥ä½œç´€éŒ„å‚™ä»½
    private DateTime? worklogStartDate;
    private DateTime? worklogEndDate;
    private bool worklogIncludeAttachments = false;
    private bool isExportingWorkLog = false;

    // ç³»çµ±è³‡æ–™å‚™ä»½
    private bool isExportingSystem = false;

    // æ¬Šé™æª¢æŸ¥
    private bool isAdmin = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isAdmin = user.IsInRole("Admin");
    }

    private async Task ExportWorkLogData()
    {
        isExportingWorkLog = true;

        try
        {
            var bytes = await ExportService.ExportWorkLogDataAsync(worklogStartDate, worklogEndDate, worklogIncludeAttachments);

            if (bytes == null)
            {
                Snackbar.Add("åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", Severity.Error);
                return;
            }

            // è§¸ç™¼æª”æ¡ˆä¸‹è¼‰
            var fileName = $"worklog-data-{DateTime.Now:yyyyMMdd-HHmmss}.zip";
            await JS.InvokeVoidAsync("downloadFile", fileName, "application/zip", bytes);

            Snackbar.Add($"åŒ¯å‡ºæˆåŠŸï¼æª”æ¡ˆå·²ä¸‹è¼‰ï¼š{fileName}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"åŒ¯å‡ºå¤±æ•—ï¼š{ex.Message}", Severity.Error);
        }
        finally
        {
            isExportingWorkLog = false;
        }
    }

    private async Task ExportSystemData()
    {
        isExportingSystem = true;

        try
        {
            var bytes = await ExportService.ExportSystemDataAsync();

            if (bytes == null)
            {
                Snackbar.Add("åŒ¯å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦", Severity.Error);
                return;
            }

            // è§¸ç™¼æª”æ¡ˆä¸‹è¼‰
            var fileName = $"system-data-{DateTime.Now:yyyyMMdd-HHmmss}.zip";
            await JS.InvokeVoidAsync("downloadFile", fileName, "application/zip", bytes);

            Snackbar.Add($"åŒ¯å‡ºæˆåŠŸï¼æª”æ¡ˆå·²ä¸‹è¼‰ï¼š{fileName}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"åŒ¯å‡ºå¤±æ•—ï¼š{ex.Message}", Severity.Error);
        }
        finally
        {
            isExportingSystem = false;
        }
    }
}
