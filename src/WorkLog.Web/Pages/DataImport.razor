@page "/data-import"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using WorkLog.Shared.DTOs.Export
@using WorkLog.Web.Services
@inject DataExportService ExportService
@inject NavigationManager Navigation
@attribute [Authorize]

<div class="container mx-auto px-4 py-6 max-w-4xl">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">åŒ¯å…¥è³‡æ–™</h1>

    <div class="bg-white rounded-lg shadow-sm p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">é¸æ“‡åŒ¯å…¥æª”æ¡ˆ</h2>

        <!-- æª”æ¡ˆä¸Šå‚³ -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                é¸æ“‡ ZIP æª”æ¡ˆ
            </label>
            <InputFile OnChange="HandleFileSelected" accept=".zip" class="block w-full text-sm text-gray-500
                file:mr-4 file:py-2 file:px-4
                file:rounded-md file:border-0
                file:text-sm file:font-semibold
                file:bg-blue-50 file:text-blue-700
                hover:file:bg-blue-100
                cursor-pointer" />
            @if (selectedFile != null)
            {
                <p class="mt-2 text-sm text-gray-600">
                    å·²é¸æ“‡ï¼š<span class="font-medium">@selectedFile.Name</span>
                    ï¼ˆ@FormatFileSize(selectedFile.Size)ï¼‰
                </p>
            }
        </div>

        <!-- é©—è­‰æŒ‰éˆ• -->
        @if (selectedFile != null && validationResult == null && importResult == null)
        {
            <button @onclick="ValidateFile" disabled="@isValidating"
                    class="bg-yellow-600 hover:bg-yellow-700 text-white px-6 py-2 rounded-lg disabled:bg-gray-400 disabled:cursor-not-allowed">
                @if (isValidating)
                {
                    <span class="inline-flex items-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        é©—è­‰ä¸­...
                    </span>
                }
                else
                {
                    <span>ğŸ” é©—è­‰æª”æ¡ˆ</span>
                }
            </button>
        }

        <!-- é©—è­‰çµæœ -->
        @if (validationResult != null)
        {
            var result = validationResult;
            <div class="mt-4 p-4 rounded-md @(result.Success ? "bg-green-50 border border-green-200" : "bg-red-50 border border-red-200")">
                <h3 class="font-semibold @(result.Success ? "text-green-800" : "text-red-800") mb-2">
                    @(result.Success ? "âœ“ é©—è­‰é€šé" : "âœ— é©—è­‰å¤±æ•—")
                </h3>
                <p class="text-sm @(result.Success ? "text-green-700" : "text-red-700")">@result.Message</p>
                
                @if (result.Warnings.Any())
                {
                    <div class="mt-2">
                        <p class="text-sm font-medium text-yellow-700">è­¦å‘Šï¼š</p>
                        <ul class="text-sm text-yellow-600 list-disc list-inside">
                            @foreach (var warning in result.Warnings)
                            {
                                <li>@warning</li>
                            }
                        </ul>
                    </div>
                }

                @if (result.Errors.Any())
                {
                    <div class="mt-2">
                        <p class="text-sm font-medium text-red-700">éŒ¯èª¤ï¼š</p>
                        <ul class="text-sm text-red-600 list-disc list-inside">
                            @foreach (var error in result.Errors)
                            {
                                <li>@error</li>
                            }
                        </ul>
                    </div>
                }

                @if (result.Success)
                {
                    <div class="mt-4">
                        <button @onclick="ImportFile" disabled="@isImporting"
                                class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg disabled:bg-gray-400 disabled:cursor-not-allowed">
                            @if (isImporting)
                            {
                                <span class="inline-flex items-center">
                                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                    åŒ¯å…¥ä¸­...
                                </span>
                            }
                            else
                            {
                                <span>ğŸ“¤ ç¢ºèªåŒ¯å…¥</span>
                            }
                        </button>
                        <button @onclick="Reset" class="ml-2 bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                            å–æ¶ˆ
                        </button>
                    </div>
                }
            </div>
        }

        <!-- åŒ¯å…¥çµæœ -->
        @if (importResult != null)
        {
            var result = importResult;
            <div class="mt-4 p-4 rounded-md @(result.Success ? "bg-green-50 border border-green-200" : "bg-red-50 border border-red-200")">
                <h3 class="font-semibold @(result.Success ? "text-green-800" : "text-red-800") mb-2">
                    @(result.Success ? "âœ“ åŒ¯å…¥æˆåŠŸ" : "âœ— åŒ¯å…¥å¤±æ•—")
                </h3>
                <p class="text-sm @(result.Success ? "text-green-700" : "text-red-700") mb-3">@result.Message</p>

                @if (result.Success)
                {
                    var stats = result.Statistics;
                    <div class="bg-white rounded p-3 text-sm space-y-2">
                        <h4 class="font-semibold text-gray-800">åŒ¯å…¥çµ±è¨ˆï¼š</h4>
                        <div class="grid grid-cols-2 gap-2 text-gray-700">
                            <div class="bg-gray-50 p-2 rounded">
                                <span class="font-medium">å·¥ä½œç´€éŒ„ï¼š</span>
                                <span class="text-green-600">@stats.WorkLogsImported ç­†æˆåŠŸ</span>
                                @if (stats.WorkLogsFailed > 0)
                                {
                                    <span class="text-red-600"> / @stats.WorkLogsFailed ç­†å¤±æ•—</span>
                                }
                            </div>
                            <div class="bg-gray-50 p-2 rounded">
                                <span class="font-medium">å¾…è¾¦äº‹é …ï¼š</span>
                                <span class="text-green-600">@stats.TodosImported ç­†æˆåŠŸ</span>
                                @if (stats.TodosFailed > 0)
                                {
                                    <span class="text-red-600"> / @stats.TodosFailed ç­†å¤±æ•—</span>
                                }
                            </div>
                            <div class="bg-gray-50 p-2 rounded">
                                <span class="font-medium">å°ˆæ¡ˆï¼š</span>
                                æ–°å¢ @stats.ProjectsCreated / è·³é @stats.ProjectsSkipped
                            </div>
                            <div class="bg-gray-50 p-2 rounded">
                                <span class="font-medium">éƒ¨é–€ï¼š</span>
                                æ–°å¢ @stats.DepartmentsCreated / è·³é @stats.DepartmentsSkipped
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 flex space-x-2">
                        <button @onclick="NavigateToHome" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg">
                            è¿”å›é¦–é 
                        </button>
                        <button @onclick="Reset" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg">
                            å†æ¬¡åŒ¯å…¥
                        </button>
                    </div>
                }

                @if (result.Errors.Any())
                {
                    <div class="mt-2">
                        <p class="text-sm font-medium text-red-700">éŒ¯èª¤è©³æƒ…ï¼š</p>
                        <ul class="text-sm text-red-600 list-disc list-inside max-h-40 overflow-y-auto">
                            @foreach (var error in result.Errors)
                            {
                                <li>@error</li>
                            }
                        </ul>
                    </div>
                }
            </div>
        }
    </div>

    <!-- èªªæ˜ -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
        <h3 class="font-semibold text-yellow-800 mb-2">âš ï¸ åŒ¯å…¥æ³¨æ„äº‹é …</h3>
        <ul class="text-sm text-yellow-700 space-y-1">
            <li>â€¢ åŒ¯å…¥çš„è³‡æ–™æœƒæ–°å¢åˆ°æ‚¨çš„å¸³è™Ÿä¸­ï¼Œä¸æœƒåˆªé™¤ç¾æœ‰è³‡æ–™</li>
            <li>â€¢ å¦‚æœåƒç…§è³‡æ–™ï¼ˆå°ˆæ¡ˆã€éƒ¨é–€ç­‰ï¼‰å·²å­˜åœ¨åŒåé …ç›®ï¼Œå°‡ä½¿ç”¨ç¾æœ‰é …ç›®</li>
            <li>â€¢ åŒ¯å…¥éç¨‹æœƒåœ¨äº¤æ˜“ä¸­åŸ·è¡Œï¼Œå¦‚æœç™¼ç”ŸéŒ¯èª¤æœƒè‡ªå‹•å›æ»¾</li>
            <li>â€¢ å»ºè­°å…ˆåœ¨æ¸¬è©¦ç’°å¢ƒé©—è­‰åŒ¯å…¥æª”æ¡ˆ</li>
            <li>â€¢ å¤§å‹æª”æ¡ˆå¯èƒ½éœ€è¦è¼ƒé•·æ™‚é–“è™•ç†ï¼Œè«‹è€å¿ƒç­‰å¾…</li>
        </ul>
    </div>
</div>

@code {
    private IBrowserFile? selectedFile;
    private byte[]? fileBytes;
    private bool isValidating = false;
    private bool isImporting = false;
    private DataImportResultDto? validationResult;
    private DataImportResultDto? importResult;

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        fileBytes = null;
        validationResult = null;
        importResult = null;

        if (selectedFile != null)
        {
            // é™åˆ¶æª”æ¡ˆå¤§å° 50MB
            if (selectedFile.Size > 52428800)
            {
                validationResult = new DataImportResultDto
                {
                    Success = false,
                    Errors = new List<string> { "æª”æ¡ˆå¤§å°ä¸å¯è¶…é 50 MB" }
                };
                selectedFile = null;
                return;
            }

            // è®€å–æª”æ¡ˆå…§å®¹
            using var stream = selectedFile.OpenReadStream(maxAllowedSize: 52428800);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            fileBytes = ms.ToArray();
        }
    }

    private async Task ValidateFile()
    {
        if (fileBytes == null) return;

        isValidating = true;
        try
        {
            validationResult = await ExportService.ValidateImportFileAsync(fileBytes);
        }
        catch (Exception ex)
        {
            validationResult = new DataImportResultDto
            {
                Success = false,
                Errors = new List<string> { $"é©—è­‰å¤±æ•—ï¼š{ex.Message}" }
            };
        }
        finally
        {
            isValidating = false;
        }
    }

    private async Task ImportFile()
    {
        if (fileBytes == null) return;

        isImporting = true;
        try
        {
            importResult = await ExportService.ImportDataAsync(fileBytes);
        }
        catch (Exception ex)
        {
            importResult = new DataImportResultDto
            {
                Success = false,
                Errors = new List<string> { $"åŒ¯å…¥å¤±æ•—ï¼š{ex.Message}" }
            };
        }
        finally
        {
            isImporting = false;
        }
    }

    private void Reset()
    {
        selectedFile = null;
        fileBytes = null;
        validationResult = null;
        importResult = null;
    }

    private void NavigateToHome()
    {
        Navigation.NavigateTo("/");
    }

    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F2} KB";
        return $"{bytes / (1024.0 * 1024.0):F2} MB";
    }
}
