@page "/data-import"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using WorkLog.Shared.DTOs.Export
@using WorkLog.Web.Services
@using System.Security.Claims
@inject DataExportService ExportService
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@attribute [Authorize]

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
    <MudText Typo="Typo.h4" Class="mb-6">è³‡æ–™åŒ¯å…¥</MudText>

    <MudGrid Spacing="3" Class="mb-6">
        <!-- å·¦å´ï¼šå·¥ä½œç´€éŒ„åŒ¯å…¥ -->
        <MudItem xs="12" lg="6">
            <MudPaper Elevation="2" Class="pa-6">
                <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
                    <MudText Typo="Typo.h3">ğŸ“‹</MudText>
                    <MudText Typo="Typo.h6">å·¥ä½œç´€éŒ„åŒ¯å…¥</MudText>
                </MudStack>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                    åŒ¯å…¥å·¥ä½œç´€éŒ„å’Œå¾…è¾¦äº‹é …å‚™ä»½æª”
                </MudText>

                <!-- æª”æ¡ˆä¸Šå‚³ -->
                <MudFileUpload T="IBrowserFile" Accept=".zip" FilesChanged="HandleWorkLogFileSelected" MaximumFileCount="1">
                    <ActivatorContent>
                        <MudButton Variant="Variant.Outlined" 
                                  Color="Color.Primary" 
                                  StartIcon="@Icons.Material.Filled.CloudUpload"
                                  FullWidth="true">
                            é¸æ“‡ ZIP æª”æ¡ˆ
                        </MudButton>
                    </ActivatorContent>
                </MudFileUpload>
                
                @if (worklogFile != null)
                {
                    <MudChip T="string" Color="Color.Info" Icon="@Icons.Material.Filled.AttachFile" Class="mt-2">
                        @worklogFile.Name (@FormatFileSize(worklogFile.Size))
                    </MudChip>
                }

                <!-- é©—è­‰æŒ‰éˆ• -->
                @if (worklogFile != null && worklogValidation == null && worklogImportResult == null)
                {
                    <MudButton Variant="Variant.Filled" 
                              Color="Color.Warning" 
                              FullWidth="true"
                              OnClick="@(async () => await ValidateWorkLogFile())"
                              Disabled="@isValidatingWorkLog"
                              StartIcon="@Icons.Material.Filled.Search"
                              Class="mt-3">
                        @(isValidatingWorkLog ? "é©—è­‰ä¸­..." : "é©—è­‰æª”æ¡ˆ")
                    </MudButton>
                }

                <!-- é©—è­‰çµæœ -->
                @if (worklogValidation != null)
                {
                    <MudAlert Severity="@(worklogValidation.Success ? Severity.Success : Severity.Error)" 
                             Variant="Variant.Filled" 
                             Class="mt-4">
                        <MudText Typo="Typo.body2" Class="font-weight-bold">
                            @(worklogValidation.Success ? "âœ“ é©—è­‰é€šé" : "âœ— é©—è­‰å¤±æ•—")
                        </MudText>
                        <MudText Typo="Typo.caption">@worklogValidation.Message</MudText>
                        
                        @if (worklogValidation.Errors.Any())
                        {
                            <div class="mt-2">
                                @foreach (var error in worklogValidation.Errors)
                                {
                                    <MudText Typo="Typo.caption">â€¢ @error</MudText>
                                }
                            </div>
                        }
                    </MudAlert>

                    @if (worklogValidation.Success)
                    {
                        <MudStack Row="true" Class="mt-3">
                            <MudButton Variant="Variant.Filled" 
                                      Color="Color.Success" 
                                      OnClick="@(async () => await ImportWorkLogFile())"
                                      Disabled="@isImportingWorkLog"
                                      StartIcon="@Icons.Material.Filled.Upload"
                                      Class="flex-grow-1">
                                @(isImportingWorkLog ? "åŒ¯å…¥ä¸­..." : "ç¢ºèªåŒ¯å…¥")
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" 
                                      OnClick="@(() => ResetWorkLog())">
                                å–æ¶ˆ
                            </MudButton>
                        </MudStack>
                    }
                }

                <!-- åŒ¯å…¥çµæœ -->
                @if (worklogImportResult != null)
                {
                    <MudAlert Severity="@(worklogImportResult.Success ? Severity.Success : Severity.Error)" 
                             Variant="Variant.Filled" 
                             Class="mt-4">
                        <MudText Typo="Typo.body2" Class="font-weight-bold">
                            @(worklogImportResult.Success ? "âœ“ åŒ¯å…¥æˆåŠŸ" : "âœ— åŒ¯å…¥å¤±æ•—")
                        </MudText>
                        <MudText Typo="Typo.caption" Class="mb-2">@worklogImportResult.Message</MudText>

                        @if (worklogImportResult.Success)
                        {
                            var stats = worklogImportResult.Statistics;
                            <MudPaper Elevation="0" Class="pa-2 mt-2" Style="background-color: rgba(255,255,255,0.2);">
                                <MudStack Spacing="1">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                                        <MudText Typo="Typo.caption">å·¥ä½œç´€éŒ„ï¼š</MudText>
                                        <MudText Typo="Typo.caption" Class="font-weight-bold">@stats.WorkLogsImported ç­†</MudText>
                                    </MudStack>
                                    <MudStack Row="true" Justify="Justify.SpaceBetween">
                                        <MudText Typo="Typo.caption">å¾…è¾¦äº‹é …ï¼š</MudText>
                                        <MudText Typo="Typo.caption" Class="font-weight-bold">@stats.TodosImported ç­†</MudText>
                                    </MudStack>
                                </MudStack>
                            </MudPaper>
                        }

                        @if (worklogImportResult.Errors.Any())
                        {
                            <div class="mt-2" style="max-height: 150px; overflow-y: auto;">
                                @foreach (var error in worklogImportResult.Errors)
                                {
                                    <MudText Typo="Typo.caption">â€¢ @error</MudText>
                                }
                            </div>
                        }
                    </MudAlert>

                    @if (worklogImportResult.Success)
                    {
                        <MudStack Row="true" Class="mt-3">
                            <MudButton Variant="Variant.Filled" 
                                      Color="Color.Primary" 
                                      OnClick="@(() => NavigateToHome())"
                                      Class="flex-grow-1">
                                è¿”å›é¦–é 
                            </MudButton>
                            <MudButton Variant="Variant.Outlined" 
                                      OnClick="@(() => ResetWorkLog())">
                                å†æ¬¡åŒ¯å…¥
                            </MudButton>
                        </MudStack>
                    }
                }

                <!-- èªªæ˜ -->
                <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true" Class="mt-4">
                    <MudText Typo="Typo.caption" Class="font-weight-bold mb-1">æ³¨æ„äº‹é …ï¼š</MudText>
                    <div class="py-0">
                        <MudText Typo="Typo.caption">â€¢ è³‡æ–™æœƒæ–°å¢åˆ°æ‚¨çš„å¸³è™Ÿä¸­</MudText>
                        <MudText Typo="Typo.caption">â€¢ ä¸æœƒåˆªé™¤ç¾æœ‰è³‡æ–™</MudText>
                        <MudText Typo="Typo.caption">â€¢ å¤±æ•—æ™‚æœƒè‡ªå‹•å›æ»¾</MudText>
                        <MudText Typo="Typo.caption">â€¢ æª”æ¡ˆé™åˆ¶ 50 MB</MudText>
                    </div>
                </MudAlert>
            </MudPaper>
        </MudItem>

        <!-- å³å´ï¼šç³»çµ±ç®¡ç†è³‡æ–™åŒ¯å…¥ -->
        <MudItem xs="12" lg="6">
            <MudPaper Elevation="2" Class="pa-6">
                <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
                    <MudText Typo="Typo.h3">âš™ï¸</MudText>
                    <MudText Typo="Typo.h6">ç³»çµ±ç®¡ç†è³‡æ–™åŒ¯å…¥</MudText>
                </MudStack>
                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                    åŒ¯å…¥ç³»çµ±è¨­å®šèˆ‡åƒç…§è³‡æ–™
                </MudText>

                @if (isAdmin)
                {
                    <!-- æª”æ¡ˆä¸Šå‚³ -->
                    <MudFileUpload T="IBrowserFile" Accept=".zip" FilesChanged="HandleSystemFileSelected" MaximumFileCount="1">
                        <ActivatorContent>
                            <MudButton Variant="Variant.Outlined" 
                                      Color="Color.Secondary" 
                                      StartIcon="@Icons.Material.Filled.CloudUpload"
                                      FullWidth="true">
                                é¸æ“‡ ZIP æª”æ¡ˆ
                            </MudButton>
                        </ActivatorContent>
                    </MudFileUpload>
                    
                    @if (systemFile != null)
                    {
                        <MudChip T="string" Color="Color.Secondary" Icon="@Icons.Material.Filled.AttachFile" Class="mt-2">
                            @systemFile.Name (@FormatFileSize(systemFile.Size))
                        </MudChip>
                    }

                    <!-- é©—è­‰æŒ‰éˆ• -->
                    @if (systemFile != null && systemValidation == null && systemImportResult == null)
                    {
                        <MudButton Variant="Variant.Filled" 
                                  Color="Color.Warning" 
                                  FullWidth="true"
                                  OnClick="@(async () => await ValidateSystemFile())"
                                  Disabled="@isValidatingSystem"
                                  StartIcon="@Icons.Material.Filled.Search"
                                  Class="mt-3">
                            @(isValidatingSystem ? "é©—è­‰ä¸­..." : "é©—è­‰æª”æ¡ˆ")
                        </MudButton>
                    }

                    <!-- é©—è­‰çµæœ -->
                    @if (systemValidation != null)
                    {
                        <MudAlert Severity="@(systemValidation.Success ? Severity.Success : Severity.Error)" 
                                 Variant="Variant.Filled" 
                                 Class="mt-4">
                            <MudText Typo="Typo.body2" Class="font-weight-bold">
                                @(systemValidation.Success ? "âœ“ é©—è­‰é€šé" : "âœ— é©—è­‰å¤±æ•—")
                            </MudText>
                            <MudText Typo="Typo.caption">@systemValidation.Message</MudText>
                            
                            @if (systemValidation.Errors.Any())
                            {
                                <div class="mt-2">
                                    @foreach (var error in systemValidation.Errors)
                                    {
                                        <MudText Typo="Typo.caption">â€¢ @error</MudText>
                                    }
                                </div>
                            }
                        </MudAlert>

                        @if (systemValidation.Success)
                        {
                            <MudStack Row="true" Class="mt-3">
                                <MudButton Variant="Variant.Filled" 
                                          Color="Color.Secondary" 
                                          OnClick="@(async () => await ImportSystemFile())"
                                          Disabled="@isImportingSystem"
                                          StartIcon="@Icons.Material.Filled.Upload"
                                          Class="flex-grow-1">
                                    @(isImportingSystem ? "åŒ¯å…¥ä¸­..." : "ç¢ºèªåŒ¯å…¥")
                                </MudButton>
                                <MudButton Variant="Variant.Outlined" 
                                          OnClick="@(() => ResetSystem())">
                                    å–æ¶ˆ
                                </MudButton>
                            </MudStack>
                        }
                    }

                    <!-- åŒ¯å…¥çµæœ -->
                    @if (systemImportResult != null)
                    {
                        <MudAlert Severity="@(systemImportResult.Success ? Severity.Success : Severity.Error)" 
                                 Variant="Variant.Filled" 
                                 Class="mt-4">
                            <MudText Typo="Typo.body2" Class="font-weight-bold">
                                @(systemImportResult.Success ? "âœ“ åŒ¯å…¥æˆåŠŸ" : "âœ— åŒ¯å…¥å¤±æ•—")
                            </MudText>
                            <MudText Typo="Typo.caption" Class="mb-2">@systemImportResult.Message</MudText>

                            @if (systemImportResult.Success)
                            {
                                var stats = systemImportResult.Statistics;
                                <MudPaper Elevation="0" Class="pa-2 mt-2" Style="background-color: rgba(255,255,255,0.2);">
                                    <MudStack Spacing="1">
                                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                                            <MudText Typo="Typo.caption">å°ˆæ¡ˆï¼š</MudText>
                                            <MudText Typo="Typo.caption">+@stats.ProjectsCreated / â†·@stats.ProjectsSkipped</MudText>
                                        </MudStack>
                                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                                            <MudText Typo="Typo.caption">éƒ¨é–€ï¼š</MudText>
                                            <MudText Typo="Typo.caption">+@stats.DepartmentsCreated / â†·@stats.DepartmentsSkipped</MudText>
                                        </MudStack>
                                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                                            <MudText Typo="Typo.caption">å·¥ä½œé¡å‹ï¼š</MudText>
                                            <MudText Typo="Typo.caption">+@stats.WorkTypesCreated / â†·@stats.WorkTypesSkipped</MudText>
                                        </MudStack>
                                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                                            <MudText Typo="Typo.caption">è™•ç†ç‹€æ…‹ï¼š</MudText>
                                            <MudText Typo="Typo.caption">+@stats.ProcessStatusesCreated / â†·@stats.ProcessStatusesSkipped</MudText>
                                        </MudStack>
                                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                                            <MudText Typo="Typo.caption">å¾…è¾¦åˆ†é¡ï¼š</MudText>
                                            <MudText Typo="Typo.caption">+@stats.TodoCategoriesCreated / â†·@stats.TodoCategoriesSkipped</MudText>
                                        </MudStack>
                                    </MudStack>
                                </MudPaper>
                            }

                            @if (systemImportResult.Errors.Any())
                            {
                                <div class="mt-2" style="max-height: 150px; overflow-y: auto;">
                                    @foreach (var error in systemImportResult.Errors)
                                    {
                                        <MudText Typo="Typo.caption">â€¢ @error</MudText>
                                    }
                                </div>
                            }
                        </MudAlert>

                        <MudButton Variant="Variant.Outlined" 
                                  FullWidth="true"
                                  OnClick="@(() => ResetSystem())"
                                  Class="mt-3">
                            å†æ¬¡åŒ¯å…¥
                        </MudButton>
                    }

                    <!-- èªªæ˜ -->
                    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Dense="true" Class="mt-4">
                        <MudText Typo="Typo.caption" Class="font-weight-bold mb-1">æ³¨æ„äº‹é …ï¼š</MudText>
                        <div class="py-0">
                            <MudText Typo="Typo.caption">â€¢ åƒ…åŒ¯å…¥ç³»çµ±è¨­å®šè³‡æ–™</MudText>
                            <MudText Typo="Typo.caption">â€¢ åŒåé …ç›®æœƒè¢«è·³é</MudText>
                            <MudText Typo="Typo.caption">â€¢ å»ºè­°å…ˆåœ¨æ¸¬è©¦ç’°å¢ƒé©—è­‰</MudText>
                            <MudText Typo="Typo.caption">â€¢ æª”æ¡ˆé™åˆ¶ 10 MB</MudText>
                        </div>
                    </MudAlert>
                }
                else
                {
                    <MudPaper Elevation="0" Class="pa-6 text-center" Style="background-color: var(--mud-palette-background-grey);">
                        <MudText Typo="Typo.h3" Class="mb-2">ğŸ”’</MudText>
                        <MudText Typo="Typo.body2" Class="font-weight-bold">éœ€è¦ç®¡ç†å“¡æ¬Šé™</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="mt-1">
                            ç³»çµ±ç®¡ç†è³‡æ–™åŒ¯å…¥åŠŸèƒ½åƒ…é™ç®¡ç†å“¡ä½¿ç”¨
                        </MudText>
                    </MudPaper>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    // å·¥ä½œç´€éŒ„åŒ¯å…¥
    private IBrowserFile? worklogFile;
    private byte[]? worklogBytes;
    private bool isValidatingWorkLog = false;
    private bool isImportingWorkLog = false;
    private DataImportResultDto? worklogValidation;
    private DataImportResultDto? worklogImportResult;

    // ç³»çµ±è³‡æ–™åŒ¯å…¥
    private IBrowserFile? systemFile;
    private byte[]? systemBytes;
    private bool isValidatingSystem = false;
    private bool isImportingSystem = false;
    private DataImportResultDto? systemValidation;
    private DataImportResultDto? systemImportResult;

    // æ¬Šé™æª¢æŸ¥
    private bool isAdmin = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        isAdmin = user.IsInRole("Admin");
    }

    // å·¥ä½œç´€éŒ„åŒ¯å…¥ç›¸é—œæ–¹æ³•
    private async Task HandleWorkLogFileSelected(IBrowserFile? file)
    {
        worklogFile = file;
        worklogBytes = null;
        worklogValidation = null;
        worklogImportResult = null;

        if (worklogFile != null)
        {
            if (worklogFile.Size > 52428800) // 50 MB
            {
                Snackbar.Add("æª”æ¡ˆå¤§å°ä¸å¯è¶…é 50 MB", Severity.Error);
                worklogFile = null;
                return;
            }

            using var stream = worklogFile.OpenReadStream(maxAllowedSize: 52428800);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            worklogBytes = ms.ToArray();
        }
    }

    private async Task ValidateWorkLogFile()
    {
        if (worklogBytes == null) return;

        isValidatingWorkLog = true;
        try
        {
            worklogValidation = await ExportService.ValidateWorkLogImportFileAsync(worklogBytes);
        }
        catch (Exception ex)
        {
            worklogValidation = new DataImportResultDto
            {
                Success = false,
                Errors = new List<string> { $"é©—è­‰å¤±æ•—ï¼š{ex.Message}" }
            };
        }
        finally
        {
            isValidatingWorkLog = false;
        }
    }

    private async Task ImportWorkLogFile()
    {
        if (worklogBytes == null) return;

        // ç¢ºèªå°è©±æ¡†
        bool? confirmed = await DialogService.ShowMessageBox(
            "ç¢ºèªåŒ¯å…¥",
            "ç¢ºå®šè¦åŒ¯å…¥æ­¤å‚™ä»½æª”æ¡ˆå—ï¼Ÿè³‡æ–™å°‡æœƒæ–°å¢åˆ°æ‚¨çš„å¸³è™Ÿä¸­ã€‚",
            yesText: "ç¢ºèª", cancelText: "å–æ¶ˆ");
        
        if (confirmed != true) return;

        isImportingWorkLog = true;
        try
        {
            worklogImportResult = await ExportService.ImportWorkLogDataAsync(worklogBytes);
            if (worklogImportResult?.Success == true)
            {
                Snackbar.Add("åŒ¯å…¥æˆåŠŸï¼", Severity.Success);
            }
            else
            {
                Snackbar.Add("åŒ¯å…¥å¤±æ•—", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            worklogImportResult = new DataImportResultDto
            {
                Success = false,
                Errors = new List<string> { $"åŒ¯å…¥å¤±æ•—ï¼š{ex.Message}" }
            };
            Snackbar.Add($"åŒ¯å…¥å¤±æ•—ï¼š{ex.Message}", Severity.Error);
        }
        finally
        {
            isImportingWorkLog = false;
        }
    }

    private void ResetWorkLog()
    {
        worklogFile = null;
        worklogBytes = null;
        worklogValidation = null;
        worklogImportResult = null;
    }

    // ç³»çµ±è³‡æ–™åŒ¯å…¥ç›¸é—œæ–¹æ³•
    private async Task HandleSystemFileSelected(IBrowserFile? file)
    {
        systemFile = file;
        systemBytes = null;
        systemValidation = null;
        systemImportResult = null;

        if (systemFile != null)
        {
            if (systemFile.Size > 10485760) // 10 MB
            {
                Snackbar.Add("æª”æ¡ˆå¤§å°ä¸å¯è¶…é 10 MB", Severity.Error);
                systemFile = null;
                return;
            }

            using var stream = systemFile.OpenReadStream(maxAllowedSize: 10485760);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            systemBytes = ms.ToArray();
        }
    }

    private async Task ValidateSystemFile()
    {
        if (systemBytes == null) return;

        isValidatingSystem = true;
        try
        {
            systemValidation = await ExportService.ValidateSystemDataImportFileAsync(systemBytes);
        }
        catch (Exception ex)
        {
            systemValidation = new DataImportResultDto
            {
                Success = false,
                Errors = new List<string> { $"é©—è­‰å¤±æ•—ï¼š{ex.Message}" }
            };
        }
        finally
        {
            isValidatingSystem = false;
        }
    }

    private async Task ImportSystemFile()
    {
        if (systemBytes == null) return;

        // ç¢ºèªå°è©±æ¡†
        bool? confirmed = await DialogService.ShowMessageBox(
            "ç¢ºèªåŒ¯å…¥",
            "ç¢ºå®šè¦åŒ¯å…¥æ­¤ç³»çµ±è¨­å®šæª”æ¡ˆå—ï¼ŸåŒåé …ç›®å°‡æœƒè¢«è·³éã€‚",
            yesText: "ç¢ºèª", cancelText: "å–æ¶ˆ");
        
        if (confirmed != true) return;

        isImportingSystem = true;
        try
        {
            systemImportResult = await ExportService.ImportSystemDataAsync(systemBytes);
            if (systemImportResult?.Success == true)
            {
                Snackbar.Add("åŒ¯å…¥æˆåŠŸï¼", Severity.Success);
            }
            else
            {
                Snackbar.Add("åŒ¯å…¥å¤±æ•—", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            systemImportResult = new DataImportResultDto
            {
                Success = false,
                Errors = new List<string> { $"åŒ¯å…¥å¤±æ•—ï¼š{ex.Message}" }
            };
            Snackbar.Add($"åŒ¯å…¥å¤±æ•—ï¼š{ex.Message}", Severity.Error);
        }
        finally
        {
            isImportingSystem = false;
        }
    }

    private void ResetSystem()
    {
        systemFile = null;
        systemBytes = null;
        systemValidation = null;
        systemImportResult = null;
    }

    // å…±ç”¨æ–¹æ³•
    private void NavigateToHome()
    {
        Navigation.NavigateTo("/");
    }

    private string FormatFileSize(long bytes)
    {
        if (bytes < 1024) return $"{bytes} B";
        if (bytes < 1024 * 1024) return $"{bytes / 1024.0:F2} KB";
        return $"{bytes / (1024.0 * 1024.0):F2} MB";
    }
}
