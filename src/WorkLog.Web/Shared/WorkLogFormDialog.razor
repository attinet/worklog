@inject HttpClient Http
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@errorMessage</MudAlert>
        }

        <EditForm Model="formModel" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary Class="mb-4" />

            <MudGrid>
                @* 標題 *@
                <MudItem xs="12">
                    <MudTextField @bind-Value="formModel.Title" 
                                 Label="標題" 
                                 Variant="Variant.Outlined"
                                 Required="true"
                                 For="@(() => formModel.Title)" />
                </MudItem>

                @* 紀錄日期 *@
                <MudItem xs="12" sm="6">
                    <div class="mud-input-control mud-input-input-control">
                        <div class="mud-input-control-input-container">
                            <div class="mud-input mud-input-outlined mud-shrink">
                                <input type="date" 
                                       value="@recordDateString"
                                       @onchange="@((ChangeEventArgs e) => recordDateString = e.Value?.ToString() ?? string.Empty)"
                                       required
                                       class="mud-input-slot mud-input-root mud-input-root-outlined"
                                       style="box-sizing: border-box; padding: 16.5px 14px;" />
                                <label class="mud-input-label mud-input-label-outlined" style="transform: translate(14px, -9px) scale(0.75); z-index: 1; background: white; padding: 0 5px;">紀錄日期 *</label>
                                <fieldset class="mud-input-outlined-border">
                                    <legend style="width: 0.01px;"><span>&#8203;</span></legend>
                                </fieldset>
                            </div>
                        </div>
                    </div>
                </MudItem>

                @* 專案名稱 *@
                <MudItem xs="12" sm="6">
                    <MudSelect @bind-Value="formModel.ProjectId" 
                              Label="專案名稱" 
                              Variant="Variant.Outlined"
                              Required="true"
                              T="int">
                        <MudSelectItem Value="0" Disabled="true">-- 請選擇 --</MudSelectItem>
                        @foreach (var p in projects)
                        {
                            <MudSelectItem Value="@p.Id">@p.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                @* 工時 *@
                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="formModel.WorkHours" 
                                    Label="工時（小時）" 
                                    Variant="Variant.Outlined"
                                    Step="0.5M"
                                    Min="0M"
                                    Required="true"
                                    T="decimal" />
                </MudItem>

                @* 處理狀態 *@
                <MudItem xs="12" sm="6">
                    <MudSelect @bind-Value="formModel.ProcessStatusId" 
                              Label="處理狀態" 
                              Variant="Variant.Outlined"
                              Required="true"
                              T="int">
                        <MudSelectItem Value="0" Disabled="true">-- 請選擇 --</MudSelectItem>
                        @foreach (var s in processStatuses)
                        {
                            <MudSelectItem Value="@s.Id">@s.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                @* 業管單位（複選） *@
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle2" Class="mb-2">
                        業管單位 
                        <span style="color: var(--mud-palette-error);">*</span>
                        （可複選，請至少選擇一個）
                    </MudText>
                    @if (departments.Count > 0)
                    {
                        <MudGrid>
                            @foreach (var dept in departments)
                            {
                                <MudItem xs="6" sm="4">
                                    <MudCheckBox Value="@CheckedDepartments[dept.Id]"
                                                ValueChanged="@((bool val) => OnDepartmentChanged(dept.Id, val))"
                                                Label="@dept.Name"
                                                Color="Color.Primary" />
                                </MudItem>
                            }
                        </MudGrid>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Warning" Class="mt-2">
                            尚未建立業管單位，請聯繫管理員
                        </MudAlert>
                    }
                </MudItem>

                @* 工作類型（複選） *@
                <MudItem xs="12">
                    <MudText Typo="Typo.subtitle2" Class="mb-2">
                        工作類型 
                        <span style="color: var(--mud-palette-error);">*</span>
                        （可複選，請至少選擇一個）
                    </MudText>
                    @if (workTypes.Count > 0)
                    {
                        <MudGrid>
                            @foreach (var wt in workTypes)
                            {
                                <MudItem xs="6" sm="4">
                                    <MudCheckBox Value="@CheckedWorkTypes[wt.Id]"
                                                ValueChanged="@((bool val) => OnWorkTypeChanged(wt.Id, val))"
                                                Label="@wt.Name"
                                                Color="Color.Primary" />
                                </MudItem>
                            }
                        </MudGrid>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Warning" Class="mt-2">
                            尚未建立工作類型，請聯繫管理員
                        </MudAlert>
                    }
                </MudItem>

                @* 內文 *@
                <MudItem xs="12">
                    <MudTextField @bind-Value="formModel.Content" 
                                 Label="內文" 
                                 Variant="Variant.Outlined"
                                 Lines="5"
                                 Required="true"
                                 For="@(() => formModel.Content)" />
                </MudItem>
            </MudGrid>
        </EditForm>
    </DialogContent>
    
    <DialogActions>
        <MudButton OnClick="Cancel" 
                  Variant="Variant.Outlined" 
                  Color="Color.Default">
            取消
        </MudButton>
        <MudButton OnClick="Submit" 
                  Variant="Variant.Filled" 
                  Color="Color.Primary"
                  StartIcon="@Icons.Material.Filled.Save"
                  Disabled="@isSubmitting">
            @(isSubmitting ? "儲存中..." : "新增")
        </MudButton>
    </DialogActions>
</MudDialog>

<style>
    /* 確保原生日期選擇器不被遮擋 */
    input[type="date"]::-webkit-calendar-picker-indicator {
        z-index: 2000;
        cursor: pointer;
    }
    
    input[type="date"] {
        position: relative;
        z-index: 100;
    }
    
    /* 確保对话框容器不會裁切日期選擇器 */
    .mud-dialog,
    .mud-dialog-content,
    .mud-grid-item {
        overflow: visible !important;
    }
</style>

@code {
    [CascadingParameter] 
    private MudDialogInstance MudDialog { get; set; } = null!;

    [Parameter] 
    public DateOnly SelectedDate { get; set; }

    private WorkLogRequest formModel = new();
    private string recordDateString = string.Empty;
    private List<LookupItemDto> projects = new();
    private List<LookupItemDto> departments = new();
    private List<LookupItemDto> workTypes = new();
    private List<LookupItemDto> processStatuses = new();
    private Dictionary<int, bool> CheckedDepartments = new();
    private Dictionary<int, bool> CheckedWorkTypes = new();
    private string? errorMessage;
    private bool isSubmitting;

    protected override async Task OnInitializedAsync()
    {
        // 設定預設日期
        formModel.RecordDate = SelectedDate;
        recordDateString = SelectedDate.ToString("yyyy-MM-dd");

        await LoadLookups();

        // 初始化 checkbox 字典
        foreach (var dept in departments)
            CheckedDepartments[dept.Id] = false;
        foreach (var wt in workTypes)
            CheckedWorkTypes[wt.Id] = false;
    }

    private void OnDepartmentChanged(int deptId, bool isChecked)
    {
        CheckedDepartments[deptId] = isChecked;
        formModel.DepartmentIds = CheckedDepartments.Where(x => x.Value).Select(x => x.Key).ToList();
    }

    private void OnWorkTypeChanged(int wtId, bool isChecked)
    {
        CheckedWorkTypes[wtId] = isChecked;
        formModel.WorkTypeIds = CheckedWorkTypes.Where(x => x.Value).Select(x => x.Key).ToList();
    }

    private async Task LoadLookups()
    {
        try
        {
            projects = await Http.GetFromJsonAsync<List<LookupItemDto>>("api/lookup/projects") ?? new();
            departments = await Http.GetFromJsonAsync<List<LookupItemDto>>("api/lookup/departments") ?? new();
            workTypes = await Http.GetFromJsonAsync<List<LookupItemDto>>("api/lookup/work-types") ?? new();
            processStatuses = await Http.GetFromJsonAsync<List<LookupItemDto>>("api/lookup/statuses") ?? new();
        }
        catch { }
    }

    private async Task Submit()
    {
        isSubmitting = true;
        errorMessage = null;

        // 轉換日期
        if (!string.IsNullOrWhiteSpace(recordDateString) && DateTime.TryParse(recordDateString, out var parsedDate))
        {
            formModel.RecordDate = DateOnly.FromDateTime(parsedDate);
        }

        // 驗證必填欄位
        if (string.IsNullOrWhiteSpace(formModel.Title))
        {
            errorMessage = "請輸入標題";
            isSubmitting = false;
            return;
        }

        if (formModel.ProjectId == 0)
        {
            errorMessage = "請選擇專案";
            isSubmitting = false;
            return;
        }

        if (formModel.ProcessStatusId == 0)
        {
            errorMessage = "請選擇處理狀態";
            isSubmitting = false;
            return;
        }

        if (!formModel.DepartmentIds.Any())
        {
            errorMessage = "請至少選擇一個業管單位";
            isSubmitting = false;
            return;
        }

        if (!formModel.WorkTypeIds.Any())
        {
            errorMessage = "請至少選擇一個工作類型";
            isSubmitting = false;
            return;
        }

        if (string.IsNullOrWhiteSpace(formModel.Content))
        {
            errorMessage = "請輸入內文";
            isSubmitting = false;
            return;
        }

        try
        {
            var response = await Http.PostAsJsonAsync("api/worklogs", formModel);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("工作紀錄已新增", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                errorMessage = $"儲存失敗: {errorContent}";
                Snackbar.Add("儲存失敗，請檢查欄位是否填寫完整", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"發生錯誤: {ex.Message}";
            Snackbar.Add(errorMessage, Severity.Error);
        }

        isSubmitting = false;
    }

    private async Task HandleSubmit()
    {
        await Submit();
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
