@inject HttpClient Http
@inject ISnackbar Snackbar

<MudDialog>
    <TitleContent>
        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
            <MudIcon Icon="@Icons.Material.Filled.NoteAdd" Color="Color.Primary" />
            <MudText Typo="Typo.h6" Style="font-weight: 600;">快速新增工作紀錄</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@errorMessage</MudAlert>
        }

        <EditForm Model="formModel" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />
            <ValidationSummary Class="mb-4" />

            <MudGrid Spacing="4">
                @* 標題 *@
                <MudItem xs="12">
                    <MudTextField @bind-Value="formModel.Title" 
                                 Label="標題" 
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 Required="true"
                                 For="@(() => formModel.Title)"
                                 Adornment="Adornment.Start"
                                 AdornmentIcon="@Icons.Material.Filled.Title" />
                </MudItem>

                @* 紀錄日期 *@
                <MudItem xs="12" sm="6">
                    <Flatpickr @bind-Value="recordDate"
                              Label="紀錄日期"
                              DateFormat="Y/m/d"
                              AdornmentIcon="@Icons.Material.Filled.CalendarToday" />
                </MudItem>

                @* 專案名稱 *@
                <MudItem xs="12" sm="6">
                    <MudSelect @bind-Value="formModel.ProjectId" 
                              Label="專案名稱" 
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Required="true"
                              T="int"
                              AdornmentIcon="@Icons.Material.Filled.Folder">
                        <MudSelectItem Value="0" Disabled="true">-- 請選擇 --</MudSelectItem>
                        @foreach (var p in projects)
                        {
                            <MudSelectItem Value="@p.Id">@p.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                @* 工時 *@
                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="formModel.WorkHours" 
                                    Label="工時（小時）" 
                                    Variant="Variant.Outlined"
                                    Margin="Margin.Dense"
                                    Step="0.5M"
                                    Min="0M"
                                    Required="true"
                                    T="decimal"
                                    Adornment="Adornment.Start"
                                    AdornmentIcon="@Icons.Material.Filled.AccessTime" />
                </MudItem>

                @* 處理狀態 *@
                <MudItem xs="12" sm="6">
                    <MudSelect @bind-Value="formModel.ProcessStatusId" 
                              Label="處理狀態" 
                              Variant="Variant.Outlined"
                              Margin="Margin.Dense"
                              Required="true"
                              T="int"
                              AdornmentIcon="@Icons.Material.Filled.CheckCircle">
                        <MudSelectItem Value="0" Disabled="true">-- 請選擇 --</MudSelectItem>
                        @foreach (var s in processStatuses)
                        {
                            <MudSelectItem Value="@s.Id">@s.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                @* 業管單位（複選） *@
                <MudItem xs="12">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-1">
                        <MudIcon Icon="@Icons.Material.Filled.Business" Size="Size.Small" Color="Color.Primary" />
                        <MudText Typo="Typo.subtitle2" Color="Color.Primary" Style="font-weight: 600;">
                            業管單位
                        </MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="ml-1">
                            <span style="color: var(--mud-palette-error);">*</span> 可複選
                        </MudText>
                    </MudStack>
                    <MudDivider Class="mb-2" />
                    @if (departments.Count > 0)
                    {
                        <MudPaper Outlined="true" Class="pa-2 rounded-lg">
                            <MudGrid>
                                @foreach (var dept in departments)
                                {
                                    <MudItem xs="6" sm="4">
                                        <MudCheckBox Value="@CheckedDepartments[dept.Id]"
                                                    ValueChanged="@((bool val) => OnDepartmentChanged(dept.Id, val))"
                                                    Label="@dept.Name"
                                                    Color="Color.Primary"
                                                    Dense="true" />
                                    </MudItem>
                                }
                            </MudGrid>
                        </MudPaper>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Warning" Class="mt-2">
                            尚未建立業管單位，請聯繫管理員
                        </MudAlert>
                    }
                </MudItem>

                @* 工作類型（複選） *@
                <MudItem xs="12">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1" Class="mb-1">
                        <MudIcon Icon="@Icons.Material.Filled.Build" Size="Size.Small" Color="Color.Primary" />
                        <MudText Typo="Typo.subtitle2" Color="Color.Primary" Style="font-weight: 600;">
                            工作類型
                        </MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary" Class="ml-1">
                            <span style="color: var(--mud-palette-error);">*</span> 可複選
                        </MudText>
                    </MudStack>
                    <MudDivider Class="mb-2" />
                    @if (workTypes.Count > 0)
                    {
                        <MudPaper Outlined="true" Class="pa-2 rounded-lg">
                            <MudGrid>
                                @foreach (var wt in workTypes)
                                {
                                    <MudItem xs="6" sm="4">
                                        <MudCheckBox Value="@CheckedWorkTypes[wt.Id]"
                                                    ValueChanged="@((bool val) => OnWorkTypeChanged(wt.Id, val))"
                                                    Label="@wt.Name"
                                                    Color="Color.Primary"
                                                    Dense="true" />
                                    </MudItem>
                                }
                            </MudGrid>
                        </MudPaper>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Warning" Class="mt-2">
                            尚未建立工作類型，請聯繫管理員
                        </MudAlert>
                    }
                </MudItem>

                @* 內文 *@
                <MudItem xs="12">
                    <MudTextField @bind-Value="formModel.Content" 
                                 Label="內文" 
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 Lines="5"
                                 Required="true"
                                 For="@(() => formModel.Content)" />
                </MudItem>
            </MudGrid>
        </EditForm>
    </DialogContent>
    
    <DialogActions>
        <MudButton OnClick="Cancel" 
                  Variant="Variant.Outlined" 
                  Color="Color.Default"
                  StartIcon="@Icons.Material.Filled.Close">
            取消
        </MudButton>
        <MudButton OnClick="Submit" 
                  Variant="Variant.Filled" 
                  Color="Color.Primary"
                  StartIcon="@Icons.Material.Filled.Save"
                  Disabled="@isSubmitting">
            @(isSubmitting ? "儲存中..." : "新增")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    private MudDialogInstance MudDialog { get; set; } = null!;

    [Parameter] 
    public DateOnly SelectedDate { get; set; }

    private WorkLogRequest formModel = new();
    private DateTime? recordDate;
    private List<LookupItemDto> projects = new();
    private List<LookupItemDto> departments = new();
    private List<LookupItemDto> workTypes = new();
    private List<LookupItemDto> processStatuses = new();
    private Dictionary<int, bool> CheckedDepartments = new();
    private Dictionary<int, bool> CheckedWorkTypes = new();
    private string? errorMessage;
    private bool isSubmitting;

    protected override async Task OnInitializedAsync()
    {
        // 設定預設日期
        formModel.RecordDate = SelectedDate;
        recordDate = SelectedDate.ToDateTime(TimeOnly.MinValue);

        await LoadLookups();

        // 初始化 checkbox 字典
        foreach (var dept in departments)
            CheckedDepartments[dept.Id] = false;
        foreach (var wt in workTypes)
            CheckedWorkTypes[wt.Id] = false;
    }

    private void OnDepartmentChanged(int deptId, bool isChecked)
    {
        CheckedDepartments[deptId] = isChecked;
        formModel.DepartmentIds = CheckedDepartments.Where(x => x.Value).Select(x => x.Key).ToList();
    }

    private void OnWorkTypeChanged(int wtId, bool isChecked)
    {
        CheckedWorkTypes[wtId] = isChecked;
        formModel.WorkTypeIds = CheckedWorkTypes.Where(x => x.Value).Select(x => x.Key).ToList();
    }

    private async Task LoadLookups()
    {
        try
        {
            projects = await Http.GetFromJsonAsync<List<LookupItemDto>>("api/lookup/projects") ?? new();
            departments = await Http.GetFromJsonAsync<List<LookupItemDto>>("api/lookup/departments") ?? new();
            workTypes = await Http.GetFromJsonAsync<List<LookupItemDto>>("api/lookup/work-types") ?? new();
            processStatuses = await Http.GetFromJsonAsync<List<LookupItemDto>>("api/lookup/statuses") ?? new();
        }
        catch { }
    }

    private async Task Submit()
    {
        isSubmitting = true;
        errorMessage = null;

        // 轉換日期
        if (recordDate.HasValue)
        {
            formModel.RecordDate = DateOnly.FromDateTime(recordDate.Value);
        }

        // 驗證必填欄位
        if (string.IsNullOrWhiteSpace(formModel.Title))
        {
            errorMessage = "請輸入標題";
            isSubmitting = false;
            return;
        }

        if (formModel.ProjectId == 0)
        {
            errorMessage = "請選擇專案";
            isSubmitting = false;
            return;
        }

        if (formModel.ProcessStatusId == 0)
        {
            errorMessage = "請選擇處理狀態";
            isSubmitting = false;
            return;
        }

        if (!formModel.DepartmentIds.Any())
        {
            errorMessage = "請至少選擇一個業管單位";
            isSubmitting = false;
            return;
        }

        if (!formModel.WorkTypeIds.Any())
        {
            errorMessage = "請至少選擇一個工作類型";
            isSubmitting = false;
            return;
        }

        if (string.IsNullOrWhiteSpace(formModel.Content))
        {
            errorMessage = "請輸入內文";
            isSubmitting = false;
            return;
        }

        try
        {
            var response = await Http.PostAsJsonAsync("api/worklogs", formModel);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("工作紀錄已新增", Severity.Success);
                MudDialog.Close(DialogResult.Ok(true));
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                errorMessage = $"儲存失敗: {errorContent}";
                Snackbar.Add("儲存失敗，請檢查欄位是否填寫完整", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"發生錯誤: {ex.Message}";
            Snackbar.Add(errorMessage, Severity.Error);
        }

        isSubmitting = false;
    }

    private async Task HandleSubmit()
    {
        await Submit();
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
